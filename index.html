<!DOCTYPE html>
<html lang="en">
<head>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Advanced Financial Dashboard</title>
        
        <!-- ADD THESE GOOGLE DRIVE SCRIPTS -->
        <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
        <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
        
        <script>
        // ==================== GOOGLE DRIVE CONFIGURATION ====================
        const GOOGLE_CLIENT_ID = '9090497174-volmpgatcfokales3aeggvj1su63td5u.apps.googleusercontent.com'; // REPLACE THIS
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;
        
        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: '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',
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            updateSigninStatus();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            updateSigninStatus();
        }
        
        function updateSigninStatus() {
            const token = gapi.client.getToken();
            const statusEl = document.getElementById('driveStatus');
            if (statusEl) {
                if (token) {
                    statusEl.textContent = 'üü¢ Connected';
                    statusEl.style.color = '#43e97b';
                } else {
                    statusEl.textContent = '‚ö™ Not connected';
                    statusEl.style.color = '#999';
                }
            }
        }
        
        // Connect to Google Drive
        function connectGoogleDrive() {
            if (!gapiInited || !gisInited) {
                alert('Google Drive is still initializing. Please wait a moment and try again.');
                return;
            }
            
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error:', resp);
                    if (window.app) window.app.msg('‚ö†Ô∏è Failed to connect to Google Drive', true);
                    return;
                }
                updateSigninStatus();
                if (window.app) window.app.msg('‚úÖ Connected to Google Drive');
                
                // Load file ID from localStorage
                driveFileId = localStorage.getItem('gdrive_file_id');
                
                // Auto-save current data
                await saveToGoogleDrive();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        // Disconnect from Google Drive
        function disconnectGoogleDrive() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateSigninStatus();
                if (window.app) window.app.msg('‚úÖ Disconnected from Google Drive');
            }
        }
        
        // Save to Google Drive
        async function saveToGoogleDrive() {
            if (!gapi.client.getToken()) {
                if (window.app) window.app.msg('‚ö†Ô∏è Please connect to Google Drive first', true);
                return;
            }
            
            if (!window.app) {
                console.error('App not ready');
                return;
            }
            
            const data = JSON.stringify({
                data: window.app.data,
                categories: window.app.categories,
                customAccounts: window.app.customAccounts || [],
                version: '15',
                lastSaved: new Date().toISOString()
            }, null, 2);
            
            try {
                const fileId = localStorage.getItem('gdrive_file_id');
                
                if (fileId) {
                    // Update existing file
                    const response = await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: {uploadType: 'media'},
                        body: data
                    });
                    console.log('‚úÖ Updated in Google Drive');
                    if (window.app) window.app.msg('‚úÖ Synced to Google Drive');
                } else {
                    // Create new file
                    const metadata = {
                        name: 'financial-dashboard-data.json',
                        mimeType: 'application/json'
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', new Blob([data], {type: 'application/json'}));
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({
                            'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                        }),
                        body: form
                    });
                    
                    const result = await response.json();
                    localStorage.setItem('gdrive_file_id', result.id);
                    driveFileId = result.id;
                    console.log('‚úÖ Created new file in Google Drive:', result.id);
                    if (window.app) window.app.msg('‚úÖ Created backup in Google Drive');
                }
            } catch (err) {
                console.error('Google Drive save error:', err);
                if (window.app) window.app.msg('‚ö†Ô∏è Failed to sync to Google Drive', true);
            }
        }
        
        // Load from Google Drive
        async function loadFromGoogleDrive() {
            if (!gapi.client.getToken()) {
                if (window.app) window.app.msg('‚ö†Ô∏è Please connect to Google Drive first', true);
                return;
            }
            
            const fileId = localStorage.getItem('gdrive_file_id');
            
            if (!fileId) {
                if (window.app) window.app.msg('‚ö†Ô∏è No Google Drive backup found. Save first to create one.', true);
                return;
            }
            
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const imported = JSON.parse(response.body);
                
                if (!window.app) {
                    console.error('App not ready');
                    return;
                }
                
                if (imported.data) window.app.data = imported.data;
                if (imported.categories) window.app.categories = imported.categories;
                if (imported.customAccounts) window.app.customAccounts = imported.customAccounts;
                
                // Validate all month structures
                for (let monthKey in window.app.data) {
                    window.app.validateMonthStructure(monthKey);
                }
                
                window.app.render();
                window.app.saveData();
                window.app.msg('‚úÖ Loaded from Google Drive');
            } catch (err) {
                console.error('Google Drive load error:', err);
                if (err.status === 404) {
                    localStorage.removeItem('gdrive_file_id');
                    if (window.app) window.app.msg('‚ö†Ô∏è Backup file not found. It may have been deleted.', true);
                } else {
                    if (window.app) window.app.msg('‚ö†Ô∏è Failed to load from Google Drive', true);
                }
            }
        }
        
        // Auto-save functionality
        let autoSaveInterval;
        function enableAutoSync() {
            // Auto-sync every 5 minutes
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => {
                if (gapi && gapi.client && gapi.client.getToken() !== null) {
                    console.log('Auto-syncing to Google Drive...');
                    saveToGoogleDrive();
                }
            }, 5 * 60 * 1000);
        }
        
        // Start auto-sync when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                enableAutoSync();
            }, 3000);
        });
        
        // Expose functions globally
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
        window.connectGoogleDrive = connectGoogleDrive;
        window.disconnectGoogleDrive = disconnectGoogleDrive;
        window.saveToGoogleDrive = saveToGoogleDrive;
        window.loadFromGoogleDrive = loadFromGoogleDrive;
        </script>
        
        <!-- Rest of your styles below -->
        <style>
   
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #667eea; 
            margin-bottom: 10px; 
            font-size: clamp(20px, 5vw, 32px);
        }
        .subtitle { 
            color: #666; 
            margin-bottom: 15px; 
            font-size: clamp(11px, 2.5vw, 14px);
        }
        
        .assets-banner {
            background: linear-gradient(135deg, #43e97b 0%, #38c968 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
        }
        .assets-label {
            font-size: clamp(11px, 2.5vw, 14px);
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            flex-wrap: wrap;
        }
        
        .month-selector label { 
            font-weight: 600; 
            font-size: clamp(12px, 2.5vw, 14px);
        }
        .month-selector select, .month-selector button {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            font-size: clamp(11px, 2.5vw, 14px);
            font-weight: 600;
            cursor: pointer;
        }
        .month-selector select { 
            min-width: 140px;
            max-width: 100%;
            background: white;
            color: #333;
        }
        .month-selector button {
            border: 2px solid white;
            background: transparent;
            color: white;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .month-selector button:hover { 
            background: white; 
            color: #667eea; 
        }
        
        @media (max-width: 768px) {
            .month-selector {
                gap: 8px;
                padding: 12px;
            }
            .month-selector label {
                width: 100%;
                margin-top: 8px;
            }
            .month-selector select {
                flex: 1;
                min-width: 0;
            }
            .month-selector button {
                flex: 1 1 auto;
                min-width: 0;
                padding: 8px 6px;
                font-size: 11px;
            }
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            font-size: clamp(10px, 2vw, 13px);
            width: 100%;
        }
        
        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #43e97b;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .summary-card:hover { 
            transform: translateY(-5px); 
        }
        .summary-label { 
            font-size: clamp(10px, 2vw, 12px);
            opacity: 0.9; 
            margin-bottom: 5px; 
        }
        .summary-value { 
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold; 
            word-break: break-word;
        }
        
        .section { 
            margin-bottom: 25px; 
        }
        .section-title {
            font-size: clamp(14px, 3vw, 18px);
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 15px;
            min-width: 500px;
        }
        th {
            background: #667eea;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: clamp(11px, 2vw, 14px);
        }
        td { 
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: clamp(11px, 2vw, 14px);
        }
        tr:hover { 
            background: #f5f5f5; 
        }
        
        @media (max-width: 768px) {
            table {
                min-width: 600px;
            }
            th, td {
                padding: 8px 6px;
            }
        }
        
        .editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .editable:hover {
            background: #e8eaf6;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: clamp(12px, 2.5vw, 14px);
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(11px, 2.5vw, 14px);
            margin-right: 8px;
            margin-bottom: 8px;
            transition: background 0.3s ease;
            white-space: nowrap;
        }
        .btn:hover { 
            background: #764ba2; 
        }
        .btn-small { 
            padding: 4px 8px; 
            font-size: clamp(10px, 2vw, 12px);
            margin-right: 4px;
        }
        .btn-success { 
            background: #43e97b; 
        }
        .btn-success:hover { 
            background: #38c968; 
        }
        .btn-delete { 
            background: #f5576c; 
        }
        .btn-delete:hover { 
            background: #dc3b50; 
        }
        
        .inline-add-row {
            background: #f8f9fa;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: clamp(11px, 2vw, 12px);
            color: #666;
            font-weight: 600;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            background: #d4edda;
            color: #155724;
            display: none;
            font-size: clamp(11px, 2.5vw, 14px);
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                padding: 15px;
            }
        }
        
        .modal-header {
            font-size: clamp(16px, 4vw, 20px);
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            line-height: 20px;
        }
        .close:hover { 
            color: #333; 
        }
        
        .subcategory-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            background: #fff3cd;
            color: #856404;
            font-size: clamp(9px, 1.8vw, 10px);
            font-weight: 600;
            margin-left: 5px;
        }
        
        .total-row { 
            background: #e8eaf6; 
            font-weight: bold; 
        }
        
        .quick-add-btn {
            padding: 3px 8px;
            font-size: clamp(10px, 2vw, 11px);
            background: #43e97b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .quick-add-btn:hover {
            background: #38c968;
        }
        
        .category-item {
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .category-name {
            font-weight: bold;
            color: #333;
            font-size: clamp(13px, 3vw, 16px);
        }
        
        .account-types {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .account-type-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: clamp(10px, 2vw, 11px);
            font-weight: 600;
            background: #e8eaf6;
            color: #667eea;
        }
        
        .category-filter {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 12px;
            font-size: clamp(12px, 2.5vw, 14px);
        }
        
        .checkbox-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: clamp(11px, 2.5vw, 14px);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .subcategories {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .subcategory-item {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: clamp(10px, 2vw, 12px);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
                border-radius: 10px;
            }
            .section {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ Advanced Financial Dashboard</h1>
        <p class="subtitle">Complete Multi-Account Management with Transfer History</p>
        
        <div class="assets-banner">
            <div class="assets-label">üíé TOTAL ASSETS ACROSS ALL ACCOUNTS</div>
            <div>¬•<span id="totalAssets">0</span></div>
        </div>
        
        <div class="month-selector">
            <label>üè¶ Account:</label>
            <select id="accountSelect" onchange="app.switchAccount()">
                <option value="mizuho">Mizuho (Main Salary)</option>
                <option value="yucho">Yucho (Investment Fund)</option>
                <option value="slsenfin">SLSenfin Account</option>
                <option value="rakuten">Rakuten Investment</option>
                <option value="medfun">7-11 Account (Med & Fun)</option>
                <option value="overview">üìä All Accounts Overview</option>
                <option value="monthly-savings">üí∞ Monthly Savings Report</option>
                <option value="annual-savings">üìà Annual Savings Report</option>
                <option value="expense-analysis">üìâ Expense Analysis & Insights</option>
            </select>
            <label>üìÖ Month:</label>
            <select id="monthSelect" onchange="app.switchMonth()"></select>
            <button onclick="app.carryForward()">‚û°Ô∏è Next Month</button>
            <button onclick="app.openTransferModal()">üí∏ Transfer</button>
            <button onclick="app.openCategoriesModal()">üè∑Ô∏è Categories</button>
            <button onclick="app.openAccountsModal()">üè¶ Accounts</button>
            
            <!-- GOOGLE DRIVE BUTTONS -->
            <button onclick="connectGoogleDrive()" style="background:#4285f4;">üîó Connect Drive</button>
            <button onclick="loadFromGoogleDrive()" style="background:#34a853;">üì• Load from Drive</button>
            
            <button onclick="app.exportData()">üíæ Export</button>
            <button onclick="document.getElementById('importFile').click()">üì• Import</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="app.importData(event)">
            
            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span id="syncStatus">Local Storage</span>
                <span id="driveStatus" style="margin-left:10px;">‚ö™ Not connected</span>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="summary-grid">
            <div class="summary-card" onclick="app.switchToAccount('mizuho')">
                <div class="summary-label">Mizuho Balance</div>
                <div class="summary-value">¬•<span id="mizuhoBalance">0</span></div>
            </div>
            <div class="summary-card" onclick="app.switchToAccount('yucho')">
                <div class="summary-label">Yucho Balance</div>
                <div class="summary-value">¬•<span id="yuchoBalance">0</span></div>
            </div>
            <div class="summary-card" onclick="app.switchToAccount('slsenfin')">
                <div class="summary-label">SLSenfin Balance</div>
                <div class="summary-value">¬•<span id="slsenfinBalance">0</span></div>
            </div>
            <div class="summary-card" onclick="app.switchToAccount('rakuten')">
                <div class="summary-label">Rakuten Balance</div>
                <div class="summary-value">¬•<span id="rakutenBalance">0</span></div>
            </div>
            <div class="summary-card" onclick="app.switchToAccount('medfun')">
                <div class="summary-label">7-11 Balance</div>
                <div class="summary-value">¬•<span id="medfunBalance">0</span></div>
            </div>
            <div id="customAccountCards"></div>
            <div class="summary-card" style="background: linear-gradient(135deg, #f5576c 0%, #dc3b50 100%);" onclick="app.showExpenseAnalysis()">
                <div class="summary-label">Total Expense (Mizuho)</div>
                <div class="summary-value">¬•<span id="totalExpenses">0</span></div>
            </div>
            <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38c968 100%);" onclick="app.showMonthlySavings()">
                <div class="summary-label">Monthly Savings</div>
                <div class="summary-value">¬•<span id="monthlySavings">0</span></div>
            </div>
            <div class="summary-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);" onclick="app.showAnnualSavings()">
                <div class="summary-label">Annual Savings</div>
                <div class="summary-value">¬•<span id="annualSavings">0</span></div>
            </div>
        </div>

        <div id="content"></div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeTransferModal()">&times;</span>
            <div class="modal-header">üí∏ Transfer Between Accounts</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>From Account</label>
                    <select id="transferFrom" onchange="app.updateTransferFromOptions()">
                        <option value="">-- Select --</option>
                        <option value="mizuho">Mizuho</option>
                        <option value="yucho">Yucho</option>
                        <option value="slsenfin">SLSenfin</option>
                        <option value="rakuten">Rakuten</option>
                        <option value="medfun">Med & Fun</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>From Fund</label>
                    <select id="transferFromFund">
                        <option value="main">Main Balance</option>
                    </select>
                </div>
            </div>
            <div style="text-align:center;font-size:24px;color:#667eea;margin:10px 0;">‚¨áÔ∏è</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>To Account</label>
                    <select id="transferTo" onchange="app.updateTransferToOptions()">
                        <option value="">-- Select --</option>
                        <option value="mizuho">Mizuho</option>
                        <option value="yucho">Yucho</option>
                        <option value="slsenfin">SLSenfin</option>
                        <option value="rakuten">Rakuten</option>
                        <option value="medfun">Med & Fun</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>To Fund</label>
                    <select id="transferToFund">
                        <option value="main">Main Balance</option>
                    </select>
                </div>
            </div>
            <div class="form-grid" style="margin-top:20px;">
                <div class="form-group">
                    <label>Amount (¬•)</label>
                    <input type="number" id="transferAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="transferDesc" placeholder="Optional">
                </div>
            </div>
            <button class="btn btn-success" onclick="app.confirmTransfer()" style="margin-top:20px;width:100%;">‚úì Confirm Transfer</button>
        </div>
    </div>

    <!-- Categories Management Modal -->
    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeCategoriesModal()">&times;</span>
            <div class="modal-header">üè∑Ô∏è Category Management</div>
            
            <div class="form-group">
                <label>Add New Category</label>
                <input type="text" id="newCategoryName" placeholder="Category name">
                
                <label style="margin-top:10px;">Available for Accounts:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="catForMizuho" checked> Mizuho</label>
                    <label><input type="checkbox" id="catForYucho" checked> Yucho</label>
                    <label><input type="checkbox" id="catForSlsenfin" checked> SLSenfin</label>
                    <label><input type="checkbox" id="catForRakuten" checked> Rakuten</label>
                    <label><input type="checkbox" id="catForMedfun" checked> Med & Fun</label>
                </div>
                
                <label style="margin-top:10px;">Category Type:</label>
                <select id="categoryType">
                    <option value="expense">Expense Category</option>
                    <option value="income">Income Category</option>
                </select>
                
                <button class="btn btn-success" onclick="app.addCategory()" style="margin-top:15px;">‚ûï Add Category</button>
            </div>
            
            <div style="margin-top:20px;">
                <label>Filter Categories:</label>
                <input type="text" class="category-filter" id="categoryFilter" onkeyup="app.filterCategories()" placeholder="Search categories...">
            </div>
            
            <div style="margin-top:20px;">
                <h4 style="color:#667eea;margin-bottom:10px;">Existing Categories:</h4>
                <div id="categoriesList"></div>
            </div>
        </div>
    </div>

    <!-- Accounts Management Modal -->
    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="app.closeAccountsModal()">&times;</span>
            <div class="modal-header">üè¶ Account Management</div>
            
            <div class="form-group">
                <label>Add New Custom Account</label>
                <input type="text" id="newAccountName" placeholder="Account name (e.g., PayPay, LINE Pay)">
                <input type="text" id="newAccountId" placeholder="Account ID (lowercase, no spaces, e.g., paypay)" style="margin-top:10px;">
                <p style="font-size:12px;color:#666;margin-top:5px;">üí° Account ID will be used internally - use lowercase letters only, no spaces</p>
                <button class="btn btn-success" onclick="app.addCustomAccount()" style="margin-top:15px;">‚ûï Add Account</button>
            </div>
            
            <div style="margin-top:30px;">
                <h4 style="color:#667eea;margin-bottom:10px;">Default Accounts:</h4>
                <div class="category-item">
                    <div class="category-name">üí∞ Mizuho (Main Salary)</div>
                    <span style="font-size:12px;color:#999;">Built-in account with fixed expenses tracking</span>
                </div>
                <div class="category-item">
                    <div class="category-name">üè¶ Yucho (Investment Fund)</div>
                    <span style="font-size:12px;color:#999;">Built-in account with multiple funds</span>
                </div>
                <div class="category-item">
                    <div class="category-name">üåê SLSenfin Account</div>
                    <span style="font-size:12px;color:#999;">Built-in standard account</span>
                </div>
                <div class="category-item">
                    <div class="category-name">üìà Rakuten Investment</div>
                    <span style="font-size:12px;color:#999;">Built-in standard account</span>
                </div>
                <div class="category-item">
                    <div class="category-name">üè™ 7-11 Account (Med & Fun)</div>
                    <span style="font-size:12px;color:#999;">Built-in standard account</span>
                </div>
            </div>
            
            <div style="margin-top:30px;" id="customAccountsList">
                <h4 style="color:#667eea;margin-bottom:10px;">Custom Accounts:</h4>
            </div>
        </div>
    </div>

    <!-- Edit Transfer Fund Modal -->
    <div id="editTransferFundModal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <span class="close" onclick="app.closeEditTransferFundModal()">&times;</span>
            <div class="modal-header">‚úèÔ∏è Edit Transfer Fund</div>
            <div class="form-group">
                <label>Select Destination Fund:</label>
                <select id="editTransferFundSelect" style="width:100%;padding:10px;">
                    <option value="">-- Select Fund --</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="app.saveTransferFundEdit()" style="margin-top:15px;width:100%;">‚úÖ Save</button>
        </div>
    </div>

    <script>
        const app = {
            data: {},
            categories: [],
            customAccounts: [], // New: Store custom account definitions
            month: '2025-11',
            acc: 'mizuho',

            init: function() {
                this.initializeCategories();
                this.initializeMonth('2025-11');
                this.loadData();
                this.render();
                this.updateTotalAssets();
            },

            initializeCategories: function() {
                this.categories = [
                    { name: 'Food and Others', accounts: ['mizuho'], type: 'expense', subcategories: ['Groceries', 'Dining Out', 'Snacks', 'Coffee', 'Others'] },
                    { name: 'To Home', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Transport', accounts: ['mizuho'], type: 'expense', subcategories: ['Train', 'Bus', 'Taxi', 'Gas', 'Parking'] },
                    { name: 'Phone', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Utility', accounts: ['mizuho'], type: 'expense', subcategories: ['Electricity', 'Water', 'Gas', 'Internet'] },
                    { name: 'Hair', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'N.Mori', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Outing', accounts: ['mizuho'], type: 'expense', subcategories: ['Movies', 'Events', 'Activities'] },
                    { name: 'House rent', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Parking', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Luqman', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Daiso/Laundry', accounts: ['mizuho'], type: 'expense', subcategories: ['Daiso', 'Laundry', 'Cleaning'] },
                    { name: 'Highways', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Sani', accounts: ['mizuho'], type: 'expense', subcategories: [] },
                    { name: 'Shopping', accounts: ['mizuho', 'yucho', 'slsenfin', 'rakuten', 'medfun'], type: 'expense', subcategories: ['Clothes', 'Electronics', 'Home', 'Others'] },
                    { name: 'Entertainment', accounts: ['mizuho', 'yucho', 'slsenfin', 'rakuten', 'medfun'], type: 'expense', subcategories: ['Streaming', 'Games', 'Books', 'Music'] },
                    { name: 'Healthcare', accounts: ['mizuho', 'yucho', 'slsenfin', 'rakuten', 'medfun'], type: 'expense', subcategories: ['Medicine', 'Doctor', 'Insurance', 'Gym'] },
                    { name: 'Salary', accounts: ['mizuho'], type: 'income', subcategories: [] },
                    { name: 'Bonus', accounts: ['mizuho'], type: 'income', subcategories: [] },
                    { name: 'Investment Return', accounts: ['yucho', 'rakuten'], type: 'income', subcategories: [] },
                    { name: 'Interest', accounts: ['yucho', 'slsenfin', 'rakuten'], type: 'income', subcategories: [] }
                ];
            },

            initializeMonth: function(monthKey) {
                if (!this.data[monthKey]) {
                    this.data[monthKey] = {
                        mizuho: {
                            salary: 353037,
                            prevBal: 726767,
                            fixedExp: {
                                'Food and Others': { budget: 40000, actual: [] },
                                'To Home': { budget: 12500, actual: [] },
                                'Transport': { budget: 15000, actual: [] },
                                'Phone': { budget: 5000, actual: [] },
                                'Utility': { budget: 25000, actual: [] },
                                'Hair': { budget: 1000, actual: [] },
                                'N.Mori': { budget: 1000, actual: [] },
                                'Outing': { budget: 5000, actual: [] },
                                'House rent': { budget: 87000, actual: [] },
                                'Parking': { budget: 20390, actual: [] },
                                'Luqman': { budget: 10000, actual: [] },
                                'Daiso/Laundry': { budget: 5000, actual: [] },
                                'Highways': { budget: 0, actual: [] },
                                'Sani': { budget: 10000, actual: [] }
                            },
                            extras: [],
                            additionalIncome: [],
                            transfers: []
                        },
                        yucho: {
                            funds: [
                                { name: 'Old JP Balance', balance: 363649 },
                                { name: 'Housing', balance: 80000 },
                                { name: 'Wedding Fund', balance: 60000 },
                                { name: 'Wedding Wappa', balance: 37500 },
                                { name: 'Extra Pay', balance: 20632 },
                                { name: 'For Luqman', balance: 80000 },
                                { name: 'Bonus', balance: 0 },
                                { name: 'Interest', balance: 503 }
                            ],
                            expenses: [],
                            additions: [],
                            transfers: []
                        },
                        slsenfin: {
                            balance: 0,
                            income: [],
                            expenses: [],
                            transfers: []
                        },
                        rakuten: {
                            balance: 0,
                            income: [],
                            expenses: [],
                            transfers: []
                        },
                        medfun: {
                            balance: 0,
                            income: [],
                            expenses: [],
                            transfers: []
                        }
                    };
                }
            },

            loadData: function() {
                const saved = localStorage.getItem('financial-dashboard-v15');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.data) {
                            this.data = parsed.data;
                            // Ensure all months have proper structure
                            for (let monthKey in this.data) {
                                this.validateMonthStructure(monthKey);
                            }
                        }
                        if (parsed.categories) this.categories = parsed.categories;
                        if (parsed.customAccounts) this.customAccounts = parsed.customAccounts;
                        this.msg('‚úÖ Data loaded');
                    } catch(e) {
                        this.msg('‚ö†Ô∏è Failed to load data', true);
                    }
                }
            },

            validateMonthStructure: function(monthKey) {
                const d = this.data[monthKey];
                if (!d) return;
                
                // Ensure Mizuho structure
                if (!d.mizuho) d.mizuho = {};
                if (!d.mizuho.fixedExp) d.mizuho.fixedExp = {};
                if (!d.mizuho.extras) d.mizuho.extras = [];
                if (!d.mizuho.transfers) d.mizuho.transfers = [];
                if (!d.mizuho.additionalIncome) d.mizuho.additionalIncome = [];
                if (d.mizuho.salary === undefined) d.mizuho.salary = 0;
                if (d.mizuho.prevBal === undefined) d.mizuho.prevBal = 0;
                
                // Ensure Yucho structure
                if (!d.yucho) d.yucho = {};
                if (!d.yucho.funds) d.yucho.funds = [];
                if (!d.yucho.expenses) d.yucho.expenses = [];
                if (!d.yucho.additions) d.yucho.additions = [];
                if (!d.yucho.transfers) d.yucho.transfers = [];
                
                // Ensure default accounts structure
                ['slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                    if (!d[acc]) d[acc] = {};
                    if (d[acc].balance === undefined) d[acc].balance = 0;
                    if (!d[acc].income) d[acc].income = [];
                    if (!d[acc].expenses) d[acc].expenses = [];
                    if (!d[acc].transfers) d[acc].transfers = [];
                });
                
                // Ensure custom accounts structure
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(customAcc => {
                        if (!d[customAcc.id]) d[customAcc.id] = {};
                        if (d[customAcc.id].balance === undefined) d[customAcc.id].balance = 0;
                        if (!d[customAcc.id].income) d[customAcc.id].income = [];
                        if (!d[customAcc.id].expenses) d[customAcc.id].expenses = [];
                        if (!d[customAcc.id].transfers) d[customAcc.id].transfers = [];
                    });
                }
            },

            saveData: function() {
                try {
                    // Before saving, update all dependent months
                    this.updateDependentMonths();
                    
                    localStorage.setItem('financial-dashboard-v15', JSON.stringify({
                        data: this.data,
                        categories: this.categories,
                        customAccounts: this.customAccounts,
                        version: '15',
                        lastSaved: new Date().toISOString()
                    }));
                    document.getElementById('syncStatus').textContent = 'Saved ' + new Date().toLocaleTimeString();
                    
                    // Auto-sync to Google Drive if connected
                    if (typeof gapi !== 'undefined' && gapi.client && gapi.client.getToken && gapi.client.getToken() !== null) {
                        setTimeout(() => {
                            saveToGoogleDrive();
                        }, 500);
                    }
                } catch(e) {
                    this.msg('‚ö†Ô∏è Failed to save', true);
                    console.error('Save error:', e);
                }
            },

            updateDependentMonths: function() {
                // Get all months sorted chronologically
                const months = Object.keys(this.data).sort();
                
                // For each month (except the last), update the next month's opening balances
                for (let i = 0; i < months.length - 1; i++) {
                    const currentMonth = months[i];
                    const nextMonth = months[i + 1];
                    
                    const currentData = this.data[currentMonth];
                    const nextData = this.data[nextMonth];
                    
                    if (!currentData || !nextData) continue;
                    
                    // Update Mizuho previous balance for next month
                    const mizuhoBalance = this.calculateMizuhoBalanceForMonth(currentMonth);
                    if (nextData.mizuho) {
                        nextData.mizuho.prevBal = mizuhoBalance;
                    }
                    
                    // Update Yucho fund balances for next month
                    if (currentData.yucho && currentData.yucho.funds && nextData.yucho && nextData.yucho.funds) {
                        // Make sure we have the same number of funds
                        if (nextData.yucho.funds.length !== currentData.yucho.funds.length) {
                            // Copy fund structure if mismatch
                            nextData.yucho.funds = currentData.yucho.funds.map(f => ({ name: f.name, balance: 0 }));
                        }
                        
                        currentData.yucho.funds.forEach((fund, fundIdx) => {
                            // Calculate ending balance for this fund
                            let balance = fund.balance;
                            
                            // Add deposits
                            if (currentData.yucho.additions) {
                                currentData.yucho.additions.forEach(a => {
                                    if (a.fundIdx === fundIdx) balance += a.amount;
                                });
                            }
                            
                            // Subtract expenses
                            if (currentData.yucho.expenses) {
                                currentData.yucho.expenses.forEach(e => {
                                    if (e.fundIdx === fundIdx) balance -= e.amount;
                                });
                            }
                            
                            // Handle transfers
                            if (currentData.yucho.transfers) {
                                currentData.yucho.transfers.forEach(t => {
                                    if (t.fundIdx === fundIdx) {
                                        if (t.type === 'in') balance += t.amount;
                                        else balance -= t.amount;
                                    }
                                });
                            }
                            
                            // Update next month's initial balance for this fund
                            if (nextData.yucho.funds[fundIdx]) {
                                nextData.yucho.funds[fundIdx].balance = balance;
                                // Ensure fund name is preserved
                                if (!nextData.yucho.funds[fundIdx].name || nextData.yucho.funds[fundIdx].name !== fund.name) {
                                    nextData.yucho.funds[fundIdx].name = fund.name;
                                }
                            }
                        });
                    }
                    
                    // Update other accounts (slsenfin, rakuten, medfun)
                    ['slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                        if (currentData[acc] && nextData[acc]) {
                            const balance = this.calculateStandardBalanceForMonth(currentMonth, acc);
                            nextData[acc].balance = balance;
                        }
                    });
                    
                    // Update custom accounts
                    if (this.customAccounts && this.customAccounts.length > 0) {
                        this.customAccounts.forEach(customAcc => {
                            if (currentData[customAcc.id] && nextData[customAcc.id]) {
                                const balance = this.calculateStandardBalanceForMonth(currentMonth, customAcc.id);
                                nextData[customAcc.id].balance = balance;
                            }
                        });
                    }
                }
            },

            calculateMizuhoBalanceForMonth: function(monthKey) {
                const d = this.data[monthKey];
                if (!d || !d.mizuho) return 0;
                
                const m = d.mizuho;
                let income = (m.salary || 0) + (m.prevBal || 0);
                
                // Add additional income
                if (m.additionalIncome) {
                    m.additionalIncome.forEach(inc => income += inc.amount);
                }
                
                let expenses = 0;
                let transfersOut = 0;
                let transfersIn = 0;
                
                for (let cat in m.fixedExp) {
                    if (m.fixedExp[cat].actual) {
                        m.fixedExp[cat].actual.forEach(e => expenses += e.amount);
                    }
                }
                
                if (m.extras) {
                    m.extras.forEach(e => expenses += e.amount);
                }
                
                if (m.transfers) {
                    m.transfers.forEach(t => {
                        if (t.type === 'out') transfersOut += t.amount;
                        else transfersIn += t.amount;
                    });
                }
                
                return income - expenses - transfersOut + transfersIn;
            },

            calculateStandardBalanceForMonth: function(monthKey, account) {
                const d = this.data[monthKey];
                if (!d || !d[account]) return 0;
                
                const acc = d[account];
                let balance = acc.balance || 0;
                
                if (acc.income) {
                    acc.income.forEach(i => balance += i.amount);
                }
                
                if (acc.expenses) {
                    acc.expenses.forEach(e => balance -= e.amount);
                }
                
                if (acc.transfers) {
                    acc.transfers.forEach(t => {
                        if (t.type === 'in') balance += t.amount;
                        else balance -= t.amount;
                    });
                }
                
                return balance;
            },

            fmt: function(n) { 
                return Math.round(n).toLocaleString(); 
            },

            msg: function(txt, isError = false) {
                const el = document.getElementById('alert');
                el.textContent = txt;
                el.className = isError ? 'alert error' : 'alert';
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 3000);
            },

            updateTotalAssets: function() {
                let total = 0;
                const d = this.data[this.month];
                
                if (d) {
                    total += this.calculateMizuhoBalance();
                    total += this.calculateYuchoBalance();
                    total += this.calculateStandardBalance('slsenfin');
                    total += this.calculateStandardBalance('rakuten');
                    total += this.calculateStandardBalance('medfun');
                    
                    // Add custom accounts
                    if (this.customAccounts && this.customAccounts.length > 0) {
                        this.customAccounts.forEach(acc => {
                            total += this.calculateStandardBalance(acc.id);
                        });
                    }
                }
                
                document.getElementById('totalAssets').textContent = this.fmt(total);
                document.getElementById('mizuhoBalance').textContent = this.fmt(this.calculateMizuhoBalance());
                document.getElementById('yuchoBalance').textContent = this.fmt(this.calculateYuchoBalance());
                document.getElementById('slsenfinBalance').textContent = this.fmt(this.calculateStandardBalance('slsenfin'));
                document.getElementById('rakutenBalance').textContent = this.fmt(this.calculateStandardBalance('rakuten'));
                document.getElementById('medfunBalance').textContent = this.fmt(this.calculateStandardBalance('medfun'));
                
                // Update custom account cards
                this.updateCustomAccountCards();
                
                // Calculate total expenses (fixed + variable)
                let totalExpenses = 0;
                if (d.mizuho) {
                    // Fixed expenses
                    if (d.mizuho.fixedExp) {
                        for (let cat in d.mizuho.fixedExp) {
                            if (d.mizuho.fixedExp[cat].actual) {
                                d.mizuho.fixedExp[cat].actual.forEach(e => totalExpenses += e.amount);
                            }
                        }
                    }
                    // Variable/Extra expenses
                    if (d.mizuho.extras) {
                        d.mizuho.extras.forEach(e => totalExpenses += e.amount);
                    }
                }
                document.getElementById('totalExpenses').textContent = this.fmt(totalExpenses);
                
                // Calculate monthly savings
                const monthlySavings = this.calculateMonthlySavings();
                document.getElementById('monthlySavings').textContent = this.fmt(monthlySavings);
                
                // Calculate annual savings
                const annualSavings = this.calculateAnnualSavings();
                document.getElementById('annualSavings').textContent = this.fmt(annualSavings);
            },

            updateCustomAccountCards: function() {
                const container = document.getElementById('customAccountCards');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(acc => {
                        const balance = this.calculateStandardBalance(acc.id);
                        const card = document.createElement('div');
                        card.className = 'summary-card';
                        card.onclick = () => this.switchToAccount(acc.id);
                        card.innerHTML = `
                            <div class="summary-label">${acc.name}</div>
                            <div class="summary-value">¬•${this.fmt(balance)}</div>
                        `;
                        container.appendChild(card);
                    });
                }
            },

            calculateMizuhoBalance: function() {
                const d = this.data[this.month];
                if (!d || !d.mizuho) return 0;
                
                const m = d.mizuho;
                let income = m.salary + m.prevBal;
                
                // Add additional income
                if (m.additionalIncome) {
                    m.additionalIncome.forEach(inc => income += inc.amount);
                }
                
                let expenses = 0;
                let transfersOut = 0;
                let transfersIn = 0;
                
                for (let cat in m.fixedExp) {
                    if (m.fixedExp[cat].actual) {
                        m.fixedExp[cat].actual.forEach(e => expenses += e.amount);
                    }
                }
                
                if (m.extras) {
                    m.extras.forEach(e => expenses += e.amount);
                }
                
                if (m.transfers) {
                    m.transfers.forEach(t => {
                        if (t.type === 'out') transfersOut += t.amount;
                        else transfersIn += t.amount;
                    });
                }
                
                return income - expenses - transfersOut + transfersIn;
            },

            calculateYuchoBalance: function() {
                const d = this.data[this.month];
                if (!d || !d.yucho) return 0;
                
                let total = 0;
                const y = d.yucho;
                
                for (let i = 0; i < y.funds.length; i++) {
                    total += y.funds[i].balance;
                    
                    if (y.additions) {
                        y.additions.forEach(a => {
                            if (a.fundIdx === i) total += a.amount;
                        });
                    }
                    
                    if (y.expenses) {
                        y.expenses.forEach(e => {
                            if (e.fundIdx === i) total -= e.amount;
                        });
                    }
                    
                    if (y.transfers) {
                        y.transfers.forEach(t => {
                            if (t.fundIdx === i) {
                                if (t.type === 'in') total += t.amount;
                                else total -= t.amount;
                            }
                        });
                    }
                }
                
                return total;
            },

            calculateStandardBalance: function(account) {
                const d = this.data[this.month];
                if (!d || !d[account]) return 0;
                
                const acc = d[account];
                let balance = acc.balance || 0;
                
                if (acc.income) {
                    acc.income.forEach(i => balance += i.amount);
                }
                
                if (acc.expenses) {
                    acc.expenses.forEach(e => balance -= e.amount);
                }
                
                if (acc.transfers) {
                    acc.transfers.forEach(t => {
                        if (t.type === 'in') balance += t.amount;
                        else balance -= t.amount;
                    });
                }
                
                return balance;
            },

            switchAccount: function() {
                this.acc = document.getElementById('accountSelect').value;
                this.render();
            },

            switchToAccount: function(account) {
                document.getElementById('accountSelect').value = account;
                this.acc = account;
                this.render();
            },

            switchMonth: function() {
                this.month = document.getElementById('monthSelect').value;
                if (!this.data[this.month]) {
                    this.initializeMonth(this.month);
                } else {
                    // Validate structure when switching to existing month
                    this.validateMonthStructure(this.month);
                }
                this.updateTotalAssets();
                this.render();
            },

            render: function() {
                const sel = document.getElementById('monthSelect');
                sel.innerHTML = '';
                const months = Object.keys(this.data).sort();
                months.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === this.month) opt.selected = true;
                    sel.appendChild(opt);
                });
                
                // Update account selector with custom accounts
                this.updateAccountSelector();
                
                if (this.acc === 'overview') {
                    this.renderOverview();
                } else if (this.acc === 'monthly-savings') {
                    this.renderMonthlySavings();
                } else if (this.acc === 'annual-savings') {
                    this.renderAnnualSavings();
                } else if (this.acc === 'expense-analysis') {
                    this.renderExpenseAnalysis();
                } else if (this.acc === 'mizuho') {
                    this.renderMizuho();
                } else if (this.acc === 'yucho') {
                    this.renderYucho();
                } else {
                    this.renderStandardAccount(this.acc);
                }
                
                this.updateTotalAssets();
            },

            updateAccountSelector: function() {
                const sel = document.getElementById('accountSelect');
                const currentValue = sel.value;
                
                sel.innerHTML = '';
                
                // Add default accounts
                const defaultAccounts = [
                    { value: 'mizuho', label: 'Mizuho (Main Salary)' },
                    { value: 'yucho', label: 'Yucho (Investment Fund)' },
                    { value: 'slsenfin', label: 'SLSenfin Account' },
                    { value: 'rakuten', label: 'Rakuten Investment' },
                    { value: 'medfun', label: '7-11 Account (Med & Fun)' }
                ];
                
                defaultAccounts.forEach(acc => {
                    const opt = document.createElement('option');
                    opt.value = acc.value;
                    opt.textContent = acc.label;
                    sel.appendChild(opt);
                });
                
                // Add custom accounts
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(acc => {
                        const opt = document.createElement('option');
                        opt.value = acc.id;
                        opt.textContent = acc.name;
                        sel.appendChild(opt);
                    });
                }
                
                // Add overview option
                const overviewOpt = document.createElement('option');
                overviewOpt.value = 'overview';
                overviewOpt.textContent = 'üìä All Accounts Overview';
                sel.appendChild(overviewOpt);
                
                // Add savings options
                const monthlySavingsOpt = document.createElement('option');
                monthlySavingsOpt.value = 'monthly-savings';
                monthlySavingsOpt.textContent = 'üí∞ Monthly Savings Report';
                sel.appendChild(monthlySavingsOpt);
                
                const annualSavingsOpt = document.createElement('option');
                annualSavingsOpt.value = 'annual-savings';
                annualSavingsOpt.textContent = 'üìà Annual Savings Report';
                sel.appendChild(annualSavingsOpt);
                
                const expenseAnalysisOpt = document.createElement('option');
                expenseAnalysisOpt.value = 'expense-analysis';
                expenseAnalysisOpt.textContent = 'üìâ Expense Analysis & Insights';
                sel.appendChild(expenseAnalysisOpt);
                
                // Restore previous selection if valid
                if (currentValue && Array.from(sel.options).some(opt => opt.value === currentValue)) {
                    sel.value = currentValue;
                }
            },

            renderMizuho: function() {
                const d = this.data[this.month].mizuho;
                let html = '';
                
                html += '<div class="section"><div class="section-title">üíµ Income & Balance</div>';
                html += '<div class="table-container"><table><thead><tr><th>Type</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
                html += '<tr><td>Monthly Salary</td>';
                html += '<td>¬•<span class="editable" onclick="app.editMizuhoSalary(' + d.salary + ')" title="Click to edit">' + this.fmt(d.salary) + '</span></td>';
                html += '<td></td></tr>';
                html += '<tr><td>Previous Balance</td>';
                html += '<td>¬•<span class="editable" onclick="app.editMizuhoPrevBal(' + d.prevBal + ')" title="Click to edit">' + this.fmt(d.prevBal) + '</span></td>';
                html += '<td></td></tr>';
                
                // Additional income entries
                if (d.additionalIncome && d.additionalIncome.length > 0) {
                    d.additionalIncome.forEach((inc, idx) => {
                        html += '<tr>';
                        html += '<td><span class="editable" onclick="app.editMizuhoIncomeField(this, ' + idx + ', \'type\', \'' + (inc.type || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + inc.type + '</span></td>';
                        html += '<td>¬•<span class="editable" onclick="app.editMizuhoIncomeField(this, ' + idx + ', \'amount\', ' + inc.amount + ')" title="Click to edit">' + this.fmt(inc.amount) + '</span></td>';
                        html += '<td><button class="btn btn-delete btn-small" onclick="app.deleteMizuhoIncomeItem(' + idx + ')">√ó</button></td>';
                        html += '</tr>';
                    });
                }
                
                // Calculate total income
                let totalIncome = d.salary + d.prevBal;
                if (d.additionalIncome) {
                    d.additionalIncome.forEach(inc => totalIncome += inc.amount);
                }
                
                html += '<tr class="total-row"><td>Total Available</td><td>¬•' + this.fmt(totalIncome) + '</td><td></td></tr>';
                
                // Add new income form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="text" id="newMizuhoIncomeType" placeholder="Income type (e.g., Bonus, Refund)" style="width:200px;"></td>';
                html += '<td><input type="number" id="newMizuhoIncomeAmt" placeholder="Amount" style="width:120px;"></td>';
                html += '<td><button class="btn btn-success btn-small" onclick="app.addMizuhoIncome()">‚ûï Add</button></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Transfer History
                html += '<div class="section"><div class="section-title">üí∏ Transfer History</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Fund</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.transfers || d.transfers.length === 0) {
                    html += '<tr><td colspan="7" style="text-align:center;color:#999">No transfers yet</td></tr>';
                } else {
                    d.transfers.forEach((t, idx) => {
                        const isOut = t.type === 'out';
                        const otherAccount = isOut ? t.toAccount : t.fromAccount;
                        const otherAccountName = otherAccount === 'yucho' ? 'Yucho' :
                                                 otherAccount === 'slsenfin' ? 'SLSenfin' :
                                                 otherAccount === 'rakuten' ? 'Rakuten' :
                                                 otherAccount === 'medfun' ? '7-11 Account' :
                                                 otherAccount === 'mizuho' ? 'Mizuho' :
                                                 this.customAccounts.find(a => a.id === otherAccount)?.name || otherAccount;
                        
                        let fundName = '-';
                        if (isOut && otherAccount === 'yucho') {
                            if (t.toFundName) fundName = t.toFundName;
                            else if (t.fundIdx !== null && t.fundIdx !== undefined && d.yucho && d.yucho.funds[t.fundIdx]) {
                                fundName = d.yucho.funds[t.fundIdx].name;
                            }
                        }
                        
                        html += '<tr style="background:' + (isOut ? '#fff3cd' : '#d4edda') + ';">';
                        html += '<td>' + t.date + '</td>';
                        html += '<td>' + (isOut ? 'üî¥ Out' : 'üü¢ In') + '</td>';
                        html += '<td>¬•' + this.fmt(t.amount) + '</td>';
                        html += '<td>' + otherAccountName + '</td>';
                        html += '<td>' + fundName + '</td>';
                        html += '<td>' + (t.desc || '-') + '</td>';
                        html += '<td>';
                        if (isOut && otherAccount === 'yucho' && (t.fundIdx === null || t.fundIdx === undefined)) {
                            html += '<button class="btn btn-small" onclick="app.editTransferFund(\'mizuho\', ' + idx + ')" style="margin-right:4px;">‚úèÔ∏è</button>';
                        }
                        html += '<button class="btn btn-delete btn-small" onclick="app.deleteTransfer(\'mizuho\', ' + idx + ')">üóëÔ∏è</button>';
                        html += '</td>';
                        html += '</tr>';
                    });
                }
                
                html += '</tbody></table></div></div>';
                
                // Fixed expenses
                html += '<div class="section"><div class="section-title">üìä Fixed Monthly Expenses</div>';
                html += '<div class="table-container"><table><thead><tr><th>Category</th><th>Budget</th><th>Actual</th><th>Remaining</th><th>Details</th><th>Quick Add</th></tr></thead><tbody>';
                
                let totalBudget = 0, totalActual = 0;
                for (let cat in d.fixedExp) {
                    const catData = d.fixedExp[cat];
                    const budget = catData.budget;
                    let actual = 0;
                    if (catData.actual) {
                        catData.actual.forEach(e => actual += e.amount);
                    }
                    const remaining = budget - actual;
                    totalBudget += budget;
                    totalActual += actual;
                    
                    html += '<tr><td>';
                    html += '<div style="display:flex;align-items:center;justify-content:space-between;">';
                    html += '<span style="font-weight:500;">' + cat + '</span>';
                    html += '<button class="btn btn-delete btn-small" onclick="app.deleteFixedCategory(\'' + cat + '\')" title="Delete category" style="margin-left:10px;">üóëÔ∏è</button>';
                    html += '</div>';
                    html += '</td>';
                    html += '<td><span class="editable" onclick="app.editBudget(\'' + cat + '\', ' + budget + ')" title="Click to edit">¬•' + this.fmt(budget) + '</span></td>';
                    html += '<td>¬•' + this.fmt(actual) + '</td>';
                    html += '<td style="color:' + (remaining >= 0 ? '#43e97b' : '#f5576c') + '">¬•' + this.fmt(Math.abs(remaining)) + '</td>';
                    html += '<td>';
                    
                    // Show details of actual expenses
                    if (catData.actual && catData.actual.length > 0) {
                        catData.actual.forEach((exp, idx) => {
                            html += '<div style="font-size:11px;margin:2px 0;display:flex;gap:5px;align-items:center;">';
                            html += '<span class="editable" onclick="app.editExpenseField(this, \'' + cat + '\', ' + idx + ', \'date\', \'' + exp.date + '\')" title="Click to edit">' + exp.date + '</span>';
                            html += ': ¬•';
                            html += '<span class="editable" onclick="app.editExpenseField(this, \'' + cat + '\', ' + idx + ', \'amount\', ' + exp.amount + ')" title="Click to edit">' + this.fmt(exp.amount) + '</span>';
                            if (exp.subcategory) html += ' <span class="subcategory-badge">' + exp.subcategory + '</span>';
                            if (exp.desc) {
                                html += ' - <span class="editable" onclick="app.editExpenseField(this, \'' + cat + '\', ' + idx + ', \'desc\', \'' + (exp.desc || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + exp.desc + '</span>';
                            }
                            html += ' <button class="btn btn-delete btn-small" onclick="app.deleteFixedExpenseItem(\'' + cat + '\', ' + idx + ')" style="margin-left:auto;">√ó</button>';
                            html += '</div>';
                        });
                    }
                    
                    html += '</td>';
                    html += '<td><button class="quick-add-btn" onclick="app.quickAddFixed(\'' + cat + '\')">+ Add</button></td>';
                    html += '</tr>';
                    
                    // Inline add form
                    html += '<tr id="add-' + cat.replace(/\s/g, '-') + '" class="inline-add-row" style="display:none;">';
                    html += '<td colspan="6"><div style="display:flex;gap:10px;align-items:center;padding:10px;">';
                    html += '<input type="date" id="date-' + cat.replace(/\s/g, '-') + '" style="width:150px;" value="' + new Date().toISOString().split('T')[0] + '">';
                    html += '<input type="number" id="amt-' + cat.replace(/\s/g, '-') + '" placeholder="Amount" style="width:100px;">';
                    
                    // Find category info for subcategories
                    let catInfo = null;
                    for (let i = 0; i < this.categories.length; i++) {
                        if (this.categories[i].name === cat) {
                            catInfo = this.categories[i];
                            break;
                        }
                    }
                    
                    // Subcategory dropdown if available
                    if (catInfo && catInfo.subcategories && catInfo.subcategories.length > 0) {
                        html += '<select id="subcat-' + cat.replace(/\s/g, '-') + '" style="width:120px;">';
                        html += '<option value="">-Subcategory-</option>';
                        for (let i = 0; i < catInfo.subcategories.length; i++) {
                            html += '<option value="' + catInfo.subcategories[i] + '">' + catInfo.subcategories[i] + '</option>';
                        }
                        html += '</select>';
                    }
                    
                    html += '<input type="text" id="desc-' + cat.replace(/\s/g, '-') + '" placeholder="Description (optional)" style="width:200px;">';
                    html += '<button class="btn btn-success btn-small" onclick="app.saveQuickFixed(\'' + cat + '\')">Save</button>';
                    html += '<button class="btn btn-small" onclick="app.cancelQuickAdd(\'' + cat + '\')">Cancel</button>';
                    html += '</div></td></tr>';
                }
                
                html += '<tr class="total-row"><td>Total</td><td>¬•' + this.fmt(totalBudget) + '</td>';
                html += '<td>¬•' + this.fmt(totalActual) + '</td>';
                html += '<td style="color:' + (totalBudget - totalActual >= 0 ? '#43e97b' : '#f5576c') + '">¬•' + this.fmt(Math.abs(totalBudget - totalActual)) + '</td>';
                html += '<td></td><td></td></tr>';
                
                // Add new fixed expense category form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="text" id="newFixedCatName" placeholder="New category name" style="width:150px;"></td>';
                html += '<td><input type="number" id="newFixedCatBudget" placeholder="Budget" style="width:100px;"></td>';
                html += '<td colspan="3" style="color:#999;font-size:11px;">Set budget for new fixed expense category</td>';
                html += '<td><button class="btn btn-success btn-small" onclick="app.addNewFixedCategory()">‚ûï Add Category</button></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Extra expenses
                html += '<div class="section"><div class="section-title">‚ûï Extra/Variable Expenses</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Amount</th><th>Description</th></tr></thead><tbody>';
                
                if (!d.extras || d.extras.length === 0) {
                    html += '<tr><td colspan="3" style="text-align:center;color:#999">No extra expenses yet</td></tr>';
                } else {
                    d.extras.forEach((e, idx) => {
                        html += '<tr>';
                        html += '<td><span class="editable" onclick="app.editExtraField(this, ' + idx + ', \'date\', \'' + e.date + '\')" title="Click to edit">' + e.date + '</span></td>';
                        html += '<td>¬•<span class="editable" onclick="app.editExtraField(this, ' + idx + ', \'amount\', ' + e.amount + ')" title="Click to edit">' + this.fmt(e.amount) + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editExtraField(this, ' + idx + ', \'desc\', \'' + (e.desc || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (e.desc || '-') + '</span>';
                        html += ' <button class="btn btn-delete btn-small" onclick="app.deleteExtraExpenseItem(' + idx + ')">√ó</button></td>';
                        html += '</tr>';
                    });
                }
                
                // Add new extra expense form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="date" id="newExtraDate" value="' + new Date().toISOString().split('T')[0] + '"></td>';
                html += '<td><input type="number" id="newExtraAmt" placeholder="Amount" style="width:120px;"></td>';
                html += '<td style="display:flex;gap:10px;"><input type="text" id="newExtraDesc" placeholder="Description" style="flex:1;">';
                html += '<button class="btn btn-success btn-small" onclick="app.addExtraExpense()">‚ûï Add</button></td>';
                html += '</tr>';
                
                html += '</tbody></table></div>';
                
                document.getElementById('content').innerHTML = html;
            },

            quickAddFixed: function(category) {
                const rowId = 'add-' + category.replace(/\s/g, '-');
                const row = document.getElementById(rowId);
                if (row) {
                    row.style.display = row.style.display === 'none' ? '' : 'none';
                }
            },

            cancelQuickAdd: function(category) {
                const rowId = 'add-' + category.replace(/\s/g, '-');
                const row = document.getElementById(rowId);
                if (row) row.style.display = 'none';
            },

            saveQuickFixed: function(category) {
                const catId = category.replace(/\s/g, '-');
                const date = document.getElementById('date-' + catId).value;
                const amount = parseFloat(document.getElementById('amt-' + catId).value);
                const subcatEl = document.getElementById('subcat-' + catId);
                const subcategory = subcatEl ? subcatEl.value : '';
                const desc = document.getElementById('desc-' + catId).value;
                
                if (!date || !amount || isNaN(amount)) {
                    this.msg('‚ö†Ô∏è Date and amount are required', true);
                    return;
                }
                
                if (!this.data[this.month].mizuho.fixedExp[category].actual) {
                    this.data[this.month].mizuho.fixedExp[category].actual = [];
                }
                
                this.data[this.month].mizuho.fixedExp[category].actual.push({
                    id: Date.now(),
                    date: date,
                    amount: amount,
                    subcategory: subcategory,
                    desc: desc
                });
                
                this.cancelQuickAdd(category);
                this.render();
                this.msg('‚úÖ Fixed expense added (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            addExtraExpense: function() {
                const dateEl = document.getElementById('newExtraDate');
                const amountEl = document.getElementById('newExtraAmt');
                const descEl = document.getElementById('newExtraDesc');
                
                if (!dateEl || !amountEl || !descEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }
                
                const date = dateEl.value;
                const amount = parseFloat(amountEl.value);
                const desc = descEl.value.trim();
                
                if (!date) {
                    this.msg('‚ö†Ô∏è Please select a date', true);
                    return;
                }
                
                if (!amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid amount', true);
                    return;
                }
                
                if (!desc) {
                    this.msg('‚ö†Ô∏è Please enter a description', true);
                    return;
                }
                
                if (!this.data[this.month].mizuho.extras) {
                    this.data[this.month].mizuho.extras = [];
                }
                
                this.data[this.month].mizuho.extras.push({
                    id: Date.now(),
                    date: date,
                    amount: amount,
                    desc: desc
                });
                
                this.render();
                this.msg('‚úÖ Extra expense added (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            renderYucho: function() {
                const d = this.data[this.month].yucho;
                let html = '<div class="section"><div class="section-title">üìä Yucho Investment Funds</div>';
                
                html += '<table><thead><tr><th>Fund</th><th>Initial</th><th>Additions</th><th>Expenses</th><th>Transfers</th><th>Current</th><th>Actions</th></tr></thead><tbody>';
                
                let grandTotal = 0;
                for (let i = 0; i < d.funds.length; i++) {
                    const f = d.funds[i];
                    let add = 0, exp = 0, transfersOut = 0, transfersIn = 0;
                    
                    if (d.additions) {
                        d.additions.forEach(a => {
                            if (a.fundIdx === i) add += a.amount;
                        });
                    }
                    
                    if (d.expenses) {
                        d.expenses.forEach(e => {
                            if (e.fundIdx === i) exp += e.amount;
                        });
                    }
                    
                    if (d.transfers) {
                        d.transfers.forEach(t => {
                            if (t.fundIdx === i) {
                                if (t.type === 'out') transfersOut += t.amount;
                                else transfersIn += t.amount;
                            }
                        });
                    }
                    
                    const netTransfers = transfersIn - transfersOut;
                    const current = f.balance + add - exp + netTransfers;
                    grandTotal += current;
                    
                    html += '<tr><td><strong><span class="editable" onclick="app.editFundName(' + i + ', \'' + f.name.replace(/'/g, "\\'") + '\')" title="Click to edit">' + f.name + '</span></strong></td>';
                    html += '<td>¬•<span class="editable" onclick="app.editFundBalance(' + i + ', ' + f.balance + ')" title="Click to edit">' + this.fmt(f.balance) + '</span></td>';
                    html += '<td>¬•' + this.fmt(add) + '</td>';
                    html += '<td>¬•' + this.fmt(exp) + '</td>';
                    html += '<td style="color:' + (netTransfers >= 0 ? '#43e97b' : '#f5576c') + '">¬•' + this.fmt(netTransfers) + '</td>';
                    html += '<td style="font-weight:bold;">¬•' + this.fmt(current) + '</td>';
                    html += '<td><button class="btn btn-delete btn-small" onclick="app.deleteFund(' + i + ')" title="Delete fund">üóëÔ∏è</button></td></tr>';
                }
                
                html += '<tr class="total-row"><td colspan="5">Total Balance</td>';
                html += '<td>¬•' + this.fmt(grandTotal) + '</td><td></td></tr>';
                
                // Add new fund row
                html += '<tr class="inline-add-row">';
                html += '<td><input type="text" id="newFundName" placeholder="New fund name" style="width:150px;"></td>';
                html += '<td><input type="number" id="newFundBalance" placeholder="Initial balance" style="width:120px;"></td>';
                html += '<td colspan="4" style="color:#999;font-size:11px;">Create a new investment fund</td>';
                html += '<td><button class="btn btn-success btn-small" onclick="app.addNewFund()">‚ûï Add Fund</button></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Direct Deposits section - NEW
                html += '<div class="section"><div class="section-title">üí∞ Direct Deposits to Funds</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Fund</th><th>Amount</th><th>Source</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.additions || d.additions.length === 0) {
                    html += '<tr><td colspan="5" style="text-align:center;color:#999">No deposits yet</td></tr>';
                } else {
                    d.additions.forEach((a, idx) => {
                        html += '<tr style="background:#d4edda;">';
                        html += '<td><span class="editable" onclick="app.editYuchoDepositField(this, ' + idx + ', \'date\', \'' + a.date + '\')" title="Click to edit">' + a.date + '</span></td>';
                        html += '<td>' + a.fundName + '</td>';
                        html += '<td>¬•<span class="editable" onclick="app.editYuchoDepositField(this, ' + idx + ', \'amount\', ' + a.amount + ')" title="Click to edit">' + this.fmt(a.amount) + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editYuchoDepositField(this, ' + idx + ', \'source\', \'' + (a.source || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (a.source || '-') + '</span>';
                        html += ' <button class="btn btn-delete btn-small" onclick="app.deleteYuchoDepositItem(' + idx + ')">√ó</button></td>';
                        html += '<td></td>';
                        html += '</tr>';
                    });
                }
                
                // Add deposit form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="date" id="yuchoDepDate" value="' + new Date().toISOString().split('T')[0] + '"></td>';
                html += '<td><select id="yuchoDepFund">';
                for (let i = 0; i < d.funds.length; i++) {
                    html += '<option value="' + i + '">' + d.funds[i].name + '</option>';
                }
                html += '</select></td>';
                html += '<td><input type="number" id="yuchoDepAmt" placeholder="Amount" style="width:100px;"></td>';
                html += '<td style="display:flex;gap:10px;"><input type="text" id="yuchoDepSource" placeholder="Source (e.g., Salary, Transfer)" style="flex:1;">';
                html += '<button class="btn btn-success btn-small" onclick="app.addYuchoDeposit()">‚ûï Add</button></td>';
                html += '<td></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Expenses section - MOVED BEFORE TRANSFER HISTORY
                html += '<div class="section"><div class="section-title">üìù Fund Expenses</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Fund</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.expenses || d.expenses.length === 0) {
                    html += '<tr><td colspan="5" style="text-align:center;color:#999">No expenses yet</td></tr>';
                } else {
                    d.expenses.forEach((e, idx) => {
                        html += '<tr>';
                        html += '<td><span class="editable" onclick="app.editYuchoExpenseField(this, ' + idx + ', \'date\', \'' + e.date + '\')" title="Click to edit">' + e.date + '</span></td>';
                        html += '<td>' + e.fundName + '</td>';
                        html += '<td>¬•<span class="editable" onclick="app.editYuchoExpenseField(this, ' + idx + ', \'amount\', ' + e.amount + ')" title="Click to edit">' + this.fmt(e.amount) + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editYuchoExpenseField(this, ' + idx + ', \'desc\', \'' + (e.desc || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (e.desc || '-') + '</span>';
                        html += ' <button class="btn btn-delete btn-small" onclick="app.deleteYuchoExpenseItem(' + idx + ')">√ó</button></td>';
                        html += '<td></td>';
                        html += '</tr>';
                    });
                }
                
                // Add expense form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="date" id="yuchoExpDate" value="' + new Date().toISOString().split('T')[0] + '"></td>';
                html += '<td><select id="yuchoExpFund">';
                for (let i = 0; i < d.funds.length; i++) {
                    html += '<option value="' + i + '">' + d.funds[i].name + '</option>';
                }
                html += '</select></td>';
                html += '<td><input type="number" id="yuchoExpAmt" placeholder="Amount" style="width:100px;"></td>';
                html += '<td style="display:flex;gap:10px;"><input type="text" id="yuchoExpDesc" placeholder="Description" style="flex:1;">';
                html += '<button class="btn btn-success btn-small" onclick="app.addYuchoExpense()">‚ûï Add</button></td>';
                html += '<td></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Transfer History
                html += '<div class="section"><div class="section-title">üí∏ Transfer History</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Type</th><th>Fund</th><th>Amount</th><th>Account</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.transfers || d.transfers.length === 0) {
                    html += '<tr><td colspan="7" style="text-align:center;color:#999">No transfers yet</td></tr>';
                } else {
                    d.transfers.forEach((t, idx) => {
                        const isOut = t.type === 'out';
                        const isIn = t.type === 'in';
                        const otherAccount = isOut ? t.toAccount : t.fromAccount;
                        const otherAccountName = otherAccount === 'yucho' ? 'Yucho' :
                                                 otherAccount === 'slsenfin' ? 'SLSenfin' :
                                                 otherAccount === 'rakuten' ? 'Rakuten' :
                                                 otherAccount === 'medfun' ? '7-11 Account' :
                                                 otherAccount === 'mizuho' ? 'Mizuho' :
                                                 this.customAccounts.find(a => a.id === otherAccount)?.name || otherAccount;
                        
                        let fundName = '-';
                        const fundIdx = t.fundIdx;
                        if (fundIdx !== null && fundIdx !== undefined && d.yucho && d.yucho.funds[fundIdx]) {
                            fundName = d.yucho.funds[fundIdx].name;
                        } else if (t.toFundName) {
                            fundName = t.toFundName;
                        } else if (t.fromFundName) {
                            fundName = t.fromFundName;
                        }
                        
                        html += '<tr style="background:' + (isOut ? '#fff3cd' : '#d4edda') + ';">';
                        html += '<td>' + t.date + '</td>';
                        html += '<td>' + (isOut ? 'üî¥ Out' : 'üü¢ In') + '</td>';
                        html += '<td>' + fundName + '</td>';
                        html += '<td>¬•' + this.fmt(t.amount) + '</td>';
                        html += '<td>' + otherAccountName + '</td>';
                        html += '<td>' + (t.desc || '-') + '</td>';
                        html += '<td style="white-space:nowrap;">';
                        html += '<button class="btn btn-delete btn-small" onclick="app.deleteTransfer(\'yucho\', ' + idx + ')">üóëÔ∏è</button>';
                        html += '</td>';
                        html += '</tr>';
                    });
                }
                
                html += '</tbody></table></div></div>';
                
                document.getElementById('content').innerHTML = html;
            },

            renderStandardAccount: function(account) {
                const d = this.data[this.month][account];
                
                // Get account name
                let accName = '';
                if (account === 'slsenfin') accName = 'SLSenfin';
                else if (account === 'rakuten') accName = 'Rakuten';
                else if (account === 'medfun') accName = '7-11 Account (Med & Fun)';
                else {
                    // Check if it's a custom account
                    const customAcc = this.customAccounts.find(a => a.id === account);
                    if (customAcc) {
                        accName = customAcc.name;
                    } else {
                        accName = account;
                    }
                }
                
                let html = '<div class="section"><div class="section-title">üíº ' + accName + '</div>';
                
                const balance = this.calculateStandardBalance(account);
                html += '<div class="assets-banner" style="margin-bottom:20px;">';
                html += '<div class="assets-label">Current Balance</div>';
                html += '<div>¬•' + this.fmt(balance) + '</div>';
                html += '</div>';
                
                // Initial Balance
                html += '<div class="section"><div class="section-title">üí∞ Initial Balance</div>';
                html += '<div class="table-container"><table><thead><tr><th>Type</th><th>Amount</th></tr></thead><tbody>';
                html += '<tr><td>Starting Balance</td>';
                html += '<td>¬•<span class="editable" onclick="app.editStandardAccountBalance(\'' + account + '\', ' + (d.balance || 0) + ')" title="Click to edit">' + this.fmt(d.balance || 0) + '</span></td></tr>';
                html += '</tbody></table></div></div>';
                
                // Income
                html += '<div class="section"><div class="section-title">üí∞ Income</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Source</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.income || d.income.length === 0) {
                    html += '<tr><td colspan="5" style="text-align:center;color:#999">No income</td></tr>';
                } else {
                    d.income.forEach((inc, idx) => {
                        html += '<tr>';
                        html += '<td><span class="editable" onclick="app.editStandardIncomeField(this, \'' + account + '\', ' + idx + ', \'date\', \'' + inc.date + '\')" title="Click to edit">' + inc.date + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editStandardIncomeField(this, \'' + account + '\', ' + idx + ', \'source\', \'' + (inc.source || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (inc.source || '-') + '</span></td>';
                        html += '<td>¬•<span class="editable" onclick="app.editStandardIncomeField(this, \'' + account + '\', ' + idx + ', \'amount\', ' + inc.amount + ')" title="Click to edit">' + this.fmt(inc.amount) + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editStandardIncomeField(this, \'' + account + '\', ' + idx + ', \'desc\', \'' + (inc.desc || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (inc.desc || '-') + '</span></td>';
                        html += '<td><button class="btn btn-delete btn-small" onclick="app.deleteStandardIncomeItem(\'' + account + '\', ' + idx + ')">√ó</button></td>';
                        html += '</tr>';
                    });
                }
                
                // Add income form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="date" id="newStdIncDate" value="' + new Date().toISOString().split('T')[0] + '"></td>';
                html += '<td><input type="text" id="newStdIncSource" placeholder="Source" style="width:120px;"></td>';
                html += '<td><input type="number" id="newStdIncAmt" placeholder="Amount" style="width:100px;"></td>';
                html += '<td style="display:flex;gap:10px;"><input type="text" id="newStdIncDesc" placeholder="Description" style="flex:1;">';
                html += '<button class="btn btn-success btn-small" onclick="app.addStandardIncome(\'' + account + '\')">‚ûï Add</button></td>';
                html += '<td></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Expenses
                html += '<div class="section"><div class="section-title">üìâ Expenses</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.expenses || d.expenses.length === 0) {
                    html += '<tr><td colspan="4" style="text-align:center;color:#999">No expenses yet</td></tr>';
                } else {
                    d.expenses.forEach((exp, idx) => {
                        html += '<tr>';
                        html += '<td><span class="editable" onclick="app.editStandardExpenseField(this, \'' + account + '\', ' + idx + ', \'date\', \'' + exp.date + '\')" title="Click to edit">' + exp.date + '</span></td>';
                        html += '<td>¬•<span class="editable" onclick="app.editStandardExpenseField(this, \'' + account + '\', ' + idx + ', \'amount\', ' + exp.amount + ')" title="Click to edit">' + this.fmt(exp.amount) + '</span></td>';
                        html += '<td><span class="editable" onclick="app.editStandardExpenseField(this, \'' + account + '\', ' + idx + ', \'desc\', \'' + (exp.desc || '').replace(/'/g, "\\'") + '\')" title="Click to edit">' + (exp.desc || '-') + '</span></td>';
                        html += '<td><button class="btn btn-delete btn-small" onclick="app.deleteStandardExpenseItem(\'' + account + '\', ' + idx + ')">√ó</button></td>';
                        html += '</tr>';
                    });
                }
                
                // Add expense form
                html += '<tr class="inline-add-row">';
                html += '<td><input type="date" id="newStdExpDate" value="' + new Date().toISOString().split('T')[0] + '"></td>';
                html += '<td><input type="number" id="newStdExpAmt" placeholder="Amount" style="width:100px;"></td>';
                html += '<td style="display:flex;gap:10px;"><input type="text" id="newStdExpDesc" placeholder="Description" style="flex:1;">';
                html += '<button class="btn btn-success btn-small" onclick="app.addStandardExpense(\'' + account + '\')">‚ûï Add</button></td>';
                html += '<td></td>';
                html += '</tr>';
                
                html += '</tbody></table></div></div>';
                
                // Transfer History
                html += '<div class="section"><div class="section-title">üí∏ Transfer History</div>';
                html += '<div class="table-container"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                if (!d.transfers || d.transfers.length === 0) {
                    html += '<tr><td colspan="6" style="text-align:center;color:#999">No transfers yet</td></tr>';
                } else {
                    d.transfers.forEach((t, idx) => {
                        const isOut = t.type === 'out';
                        const otherAccount = isOut ? t.toAccount : t.fromAccount;
                        const otherAccountName = otherAccount === 'yucho' ? 'Yucho' :
                                                 otherAccount === 'slsenfin' ? 'SLSenfin' :
                                                 otherAccount === 'rakuten' ? 'Rakuten' :
                                                 otherAccount === 'medfun' ? '7-11 Account' :
                                                 otherAccount === 'mizuho' ? 'Mizuho' :
                                                 this.customAccounts.find(a => a.id === otherAccount)?.name || otherAccount;
                        
                        html += '<tr style="background:' + (isOut ? '#fff3cd' : '#d4edda') + ';">';
                        html += '<td>' + t.date + '</td>';
                        html += '<td>' + (isOut ? 'üî¥ Out' : 'üü¢ In') + '</td>';
                        html += '<td>¬•' + this.fmt(t.amount) + '</td>';
                        html += '<td>' + otherAccountName + '</td>';
                        html += '<td>' + (t.desc || '-') + '</td>';
                        html += '<td style="white-space:nowrap;">';
                        if (isOut && otherAccount === 'yucho') {
                            html += '<button class="btn btn-small" onclick="app.editTransferFund(\'' + account + '\', ' + idx + ')" style="margin-right:4px;" title="Edit fund">‚úèÔ∏è</button>';
                        }
                        html += '<button class="btn btn-delete btn-small" onclick="app.deleteTransfer(\'' + account + '\', ' + idx + ')" title="Delete">üóëÔ∏è</button>';
                        html += '</td>';
                        html += '</tr>';
                    });
                }
                
                html += '</tbody></table></div></div>';
                
                document.getElementById('content').innerHTML = html;
            },

            renderOverview: function() {
                let html = '<div class="section"><div class="section-title">üåç All Accounts Overview</div>';
                
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">';
                
                // Default accounts
                ['mizuho', 'yucho', 'slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                    const balance = acc === 'mizuho' ? this.calculateMizuhoBalance() :
                                   acc === 'yucho' ? this.calculateYuchoBalance() :
                                   this.calculateStandardBalance(acc);
                    
                    const name = acc === 'mizuho' ? 'Mizuho' :
                                acc === 'yucho' ? 'Yucho' :
                                acc === 'slsenfin' ? 'SLSenfin' :
                                acc === 'rakuten' ? 'Rakuten' : '7-11 (Med & Fun)';
                    
                    html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;text-align:center;">';
                    html += '<h3 style="color:#667eea;margin-bottom:10px;">' + name + '</h3>';
                    html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(balance) + '</div>';
                    html += '</div>';
                });
                
                // Custom accounts
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(acc => {
                        const balance = this.calculateStandardBalance(acc.id);
                        html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;text-align:center;">';
                        html += '<h3 style="color:#667eea;margin-bottom:10px;">' + acc.name + '</h3>';
                        html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(balance) + '</div>';
                        html += '</div>';
                    });
                }
                
                html += '</div></div>';
                
                document.getElementById('content').innerHTML = html;
            },

            openTransferModal: function() {
                this.populateTransferAccounts();
                document.getElementById('transferModal').style.display = 'block';
            },

            closeTransferModal: function() {
                document.getElementById('transferModal').style.display = 'none';
            },

            updateTransferFromOptions: function() {
                const from = document.getElementById('transferFrom').value;
                const select = document.getElementById('transferFromFund');
                
                select.innerHTML = '<option value="main">Main Balance</option>';
                
                if (from === 'yucho') {
                    const funds = this.data[this.month].yucho.funds;
                    funds.forEach((f, i) => {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = f.name;
                        select.appendChild(opt);
                    });
                }
            },

            updateTransferToOptions: function() {
                const to = document.getElementById('transferTo').value;
                const select = document.getElementById('transferToFund');
                
                select.innerHTML = '<option value="main">Main Balance</option>';
                
                if (to === 'yucho') {
                    const funds = this.data[this.month].yucho.funds;
                    funds.forEach((f, i) => {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = f.name;
                        select.appendChild(opt);
                    });
                }
            },

            populateTransferAccounts: function() {
                const fromSelect = document.getElementById('transferFrom');
                const toSelect = document.getElementById('transferTo');
                
                // Clear existing options except first
                fromSelect.innerHTML = '<option value="">-- Select --</option>';
                toSelect.innerHTML = '<option value="">-- Select --</option>';
                
                // Add default accounts
                const defaultAccounts = [
                    { value: 'mizuho', label: 'Mizuho' },
                    { value: 'yucho', label: 'Yucho' },
                    { value: 'slsenfin', label: 'SLSenfin' },
                    { value: 'rakuten', label: 'Rakuten' },
                    { value: 'medfun', label: 'Med & Fun' }
                ];
                
                defaultAccounts.forEach(acc => {
                    const opt1 = document.createElement('option');
                    opt1.value = acc.value;
                    opt1.textContent = acc.label;
                    fromSelect.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = acc.value;
                    opt2.textContent = acc.label;
                    toSelect.appendChild(opt2);
                });
                
                // Add custom accounts
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(acc => {
                        const opt1 = document.createElement('option');
                        opt1.value = acc.id;
                        opt1.textContent = acc.name;
                        fromSelect.appendChild(opt1);
                        
                        const opt2 = document.createElement('option');
                        opt2.value = acc.id;
                        opt2.textContent = acc.name;
                        toSelect.appendChild(opt2);
                    });
                }
            },

            confirmTransfer: function() {
                const from = document.getElementById('transferFrom').value;
                const to = document.getElementById('transferTo').value;
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const desc = document.getElementById('transferDesc').value || 'Transfer';
                
                if (!from || !to || !amount) {
                    this.msg('‚ö†Ô∏è Please fill all required fields', true);
                    return;
                }
                
                if (from === to) {
                    this.msg('‚ö†Ô∏è Cannot transfer to same account', true);
                    return;
                }
                
                const date = new Date().toISOString().split('T')[0];
                const fromFund = document.getElementById('transferFromFund').value;
                const toFund = document.getElementById('transferToFund').value;
                const transferId = Date.now();
                
                if (!this.data[this.month][from].transfers) {
                    this.data[this.month][from].transfers = [];
                }
                
                // Get fund names for display
                let fromFundName = 'Main';
                let toFundName = 'Main';
                
                if (from === 'yucho' && fromFund !== 'main') {
                    fromFundName = this.data[this.month].yucho.funds[parseInt(fromFund)].name;
                }
                
                if (to === 'yucho' && toFund !== 'main') {
                    toFundName = this.data[this.month].yucho.funds[parseInt(toFund)].name;
                }
                
                this.data[this.month][from].transfers.push({
                    id: transferId,
                    linkedId: transferId + 1,
                    type: 'out',
                    date: date,
                    amount: amount,
                    toAccount: to,
                    toFundName: toFundName,
                    fundIdx: fromFund !== 'main' ? parseInt(fromFund) : null,
                    desc: desc
                });
                
                if (!this.data[this.month][to].transfers) {
                    this.data[this.month][to].transfers = [];
                }
                
                this.data[this.month][to].transfers.push({
                    id: transferId + 1,
                    linkedId: transferId,
                    type: 'in',
                    date: date,
                    amount: amount,
                    fromAccount: from,
                    fromFundName: fromFundName,
                    fundIdx: toFund !== 'main' ? parseInt(toFund) : null,
                    desc: desc
                });
                
                this.closeTransferModal();
                this.render();
                this.msg('‚úÖ Transfer completed: ¬•' + this.fmt(amount) + ' from ' + from + ' to ' + to);
                this.saveData();
            },

            carryForward: function() {
                const parts = this.month.split('-');
                let y = parseInt(parts[0]), m = parseInt(parts[1]);
                m++;
                if (m > 12) { m = 1; y++; }
                const next = y + '-' + (m < 10 ? '0' : '') + m;
                
                if (this.data[next]) {
                    // Show confirmation modal to override
                    this.showOverrideMonthModal(next);
                    return;
                }
                
                this.performCarryForward(next);
            },

            showOverrideMonthModal: function(nextMonth) {
                let modal = document.getElementById('overrideMonthModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'overrideMonthModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:500px;">
                            <span class="close" onclick="app.closeOverrideMonthModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Month Already Exists</div>
                            <p id="overrideMonthMsg" style="margin:20px 0;"></p>
                            <button class="btn btn-delete" onclick="app.confirmOverrideMonth(true)" style="background:#ff9800;">‚úì Yes, Recalculate & Override</button>
                            <button class="btn" onclick="app.confirmOverrideMonth(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('overrideMonthMsg').textContent = 
                    'The month ' + nextMonth + ' already exists.\n\nDo you want to recalculate and override it with correct balances from ' + this.month + '?\n\nThis will:\n‚Ä¢ Recalculate all Yucho fund balances\n‚Ä¢ Update Mizuho previous balance\n‚Ä¢ Keep your fixed expense budgets\n‚Ä¢ CLEAR all transactions in ' + nextMonth;
                document.getElementById('overrideMonthMsg').style.whiteSpace = 'pre-line';
                
                this.overrideMonthTarget = nextMonth;
                modal.style.display = 'block';
            },

            closeOverrideMonthModal: function() {
                const modal = document.getElementById('overrideMonthModal');
                if (modal) modal.style.display = 'none';
                this.overrideMonthTarget = null;
            },

            confirmOverrideMonth: function(confirmed) {
                if (confirmed && this.overrideMonthTarget) {
                    const nextMonth = this.overrideMonthTarget;
                    // Delete existing month
                    delete this.data[nextMonth];
                    // Perform carry forward
                    this.performCarryForward(nextMonth);
                }
                this.closeOverrideMonthModal();
            },

            performCarryForward: function(next) {
                // DON'T call initializeMonth - we'll create from scratch
                const currentData = this.data[this.month];
                
                // Create next month structure by copying current month's structure
                this.data[next] = {
                    mizuho: {
                        salary: currentData.mizuho.salary,
                        prevBal: this.calculateMizuhoBalance(),
                        fixedExp: {},
                        extras: [],
                        additionalIncome: [],
                        transfers: []
                    },
                    yucho: {
                        funds: [],
                        expenses: [],
                        additions: [],
                        transfers: []
                    },
                    slsenfin: {
                        balance: this.calculateStandardBalance('slsenfin'),
                        income: [],
                        expenses: [],
                        transfers: []
                    },
                    rakuten: {
                        balance: this.calculateStandardBalance('rakuten'),
                        income: [],
                        expenses: [],
                        transfers: []
                    },
                    medfun: {
                        balance: this.calculateStandardBalance('medfun'),
                        income: [],
                        expenses: [],
                        transfers: []
                    }
                };
                
                const nextData = this.data[next];
                
                // Copy fixed expense budgets
                for (let cat in currentData.mizuho.fixedExp) {
                    nextData.mizuho.fixedExp[cat] = {
                        budget: currentData.mizuho.fixedExp[cat].budget,
                        actual: []
                    };
                }
                
                // Calculate Yucho funds properly - DO NOT use default values
                console.log('=== Carrying Forward Yucho Funds to ' + next + ' ===');
                currentData.yucho.funds.forEach((fund, fundIdx) => {
                    // Start with current month's initial balance
                    let balance = fund.balance;
                    console.log('Fund:', fund.name, 'Initial:', balance);
                    
                    // Add all deposits/additions
                    if (currentData.yucho.additions) {
                        currentData.yucho.additions.forEach(a => {
                            if (a.fundIdx === fundIdx) {
                                balance += a.amount;
                                console.log('  + Deposit:', a.amount, '‚Üí', balance);
                            }
                        });
                    }
                    
                    // Subtract all expenses
                    if (currentData.yucho.expenses) {
                        currentData.yucho.expenses.forEach(e => {
                            if (e.fundIdx === fundIdx) {
                                balance -= e.amount;
                                console.log('  - Expense:', e.amount, '‚Üí', balance);
                            }
                        });
                    }
                    
                    // Handle transfers in/out
                    if (currentData.yucho.transfers) {
                        currentData.yucho.transfers.forEach(t => {
                            if (t.fundIdx === fundIdx) {
                                if (t.type === 'in') {
                                    balance += t.amount;
                                    console.log('  + Transfer In:', t.amount, '‚Üí', balance);
                                } else {
                                    balance -= t.amount;
                                    console.log('  - Transfer Out:', t.amount, '‚Üí', balance);
                                }
                            }
                        });
                    }
                    
                    console.log('‚úì Final balance for', fund.name, ':', balance);
                    
                    // Add to next month with calculated balance
                    nextData.yucho.funds.push({
                        name: fund.name,
                        balance: balance
                    });
                });
                
                // Carry forward custom accounts
                if (this.customAccounts && this.customAccounts.length > 0) {
                    this.customAccounts.forEach(acc => {
                        nextData[acc.id] = {
                            balance: this.calculateStandardBalance(acc.id),
                            income: [],
                            expenses: [],
                            transfers: []
                        };
                    });
                }
                
                // Show summary
                console.log('=== Carry Forward Complete ===');
                console.log('Mizuho prev balance:', nextData.mizuho.prevBal);
                console.log('Yucho funds:');
                nextData.yucho.funds.forEach(f => {
                    console.log('  ‚Ä¢', f.name + ':', f.balance);
                });
                
                this.month = next;
                this.render();
                this.msg('‚úÖ Carried forward to ' + next + ' with recalculated balances');
                this.saveData();
            },

            exportData: function() {
                const exportObj = {
                    data: this.data,
                    categories: this.categories,
                    customAccounts: this.customAccounts,
                    version: '15',
                    exportDate: new Date().toISOString()
                };
                
                const str = JSON.stringify(exportObj, null, 2);
                const filename = 'financial-dashboard-backup-' + new Date().toISOString().split('T')[0] + '.json';
                
                // Create a blob and download it
                try {
                    const blob = new Blob([str], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    this.msg('‚úÖ Data exported successfully as ' + filename);
                } catch(e) {
                    // Fallback: show modal with data if download fails
                    this.showExportModal(str);
                }
            },
            
            showExportModal: function(jsonStr) {
                let modal = document.getElementById('exportModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'exportModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <span class="close" onclick="app.closeExportModal()">&times;</span>
                            <div class="modal-header">üíæ Export Data</div>
                            <p style="margin-bottom:10px;">Copy this data and save it to a text file with .json extension:</p>
                            <textarea id="exportDataText" style="width:100%;height:300px;font-family:monospace;font-size:12px;padding:10px;"></textarea>
                            <div style="margin-top:10px;">
                                <button class="btn btn-success" onclick="app.copyExportData()">üìã Copy to Clipboard</button>
                                <button class="btn" onclick="app.closeExportModal()">Close</button>
                            </div>
                            <p style="margin-top:10px;font-size:12px;color:#666;">
                                üí° Tip: Save this as a .json file (e.g., financial-backup.json) to import later
                            </p>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('exportDataText').value = jsonStr;
                modal.style.display = 'block';
                
                const textarea = document.getElementById('exportDataText');
                textarea.select();
            },
            
            closeExportModal: function() {
                const modal = document.getElementById('exportModal');
                if (modal) modal.style.display = 'none';
            },
            
            copyExportData: function() {
                const textarea = document.getElementById('exportDataText');
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    this.msg('‚úÖ Data copied to clipboard! Save it as a .json file');
                } catch(e) {
                    this.msg('‚ö†Ô∏è Please manually copy the data', true);
                }
            },

            importData: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        this.showImportConfirmModal(imported);
                    } catch (err) {
                        this.msg('‚ö†Ô∏è Invalid file format', true);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },
            
            showImportConfirmModal: function(importedData) {
                let modal = document.getElementById('importConfirmModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'importConfirmModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:500px;">
                            <span class="close" onclick="app.closeImportConfirmModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Confirm Import</div>
                            <p style="margin:20px 0;">Import this data? Current data will be replaced.</p>
                            <button class="btn btn-success" onclick="app.confirmImport(true)">‚úì Yes, Import</button>
                            <button class="btn" onclick="app.confirmImport(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                this.pendingImport = importedData;
                modal.style.display = 'block';
            },
            
            closeImportConfirmModal: function() {
                const modal = document.getElementById('importConfirmModal');
                if (modal) modal.style.display = 'none';
                this.pendingImport = null;
            },
            
            confirmImport: function(confirmed) {
                if (confirmed && this.pendingImport) {
                    try {
                        if (this.pendingImport.data) {
                            this.data = this.pendingImport.data;
                            
                            // Validate all imported month structures
                            for (let monthKey in this.data) {
                                this.validateMonthStructure(monthKey);
                            }
                        }
                        if (this.pendingImport.categories) {
                            this.categories = this.pendingImport.categories;
                        }
                        
                        // Ensure current month exists
                        if (!this.data[this.month]) {
                            this.initializeMonth(this.month);
                        }
                        
                        this.render();
                        this.saveData();
                        this.msg('‚úÖ Data imported successfully');
                    } catch(e) {
                        this.msg('‚ö†Ô∏è Import failed: ' + e.message, true);
                        console.error('Import error:', e);
                    }
                }
                this.closeImportConfirmModal();
            },

            openCategoriesModal: function() {
                this.renderCategories();
                document.getElementById('categoriesModal').style.display = 'block';
            },

            closeCategoriesModal: function() {
                document.getElementById('categoriesModal').style.display = 'none';
            },

            renderCategories: function() {
                let html = '';
                
                this.categories.forEach((cat, index) => {
                    html += '<div class="category-item">';
                    html += '<div class="category-header">';
                    html += '<div class="category-name">' + cat.name;
                    html += ' <span style="color:#999;font-size:12px;">(' + cat.type + ')</span></div>';
                    html += '<button class="btn btn-delete btn-small" onclick="app.deleteCategory(' + index + ')">üóëÔ∏è</button>';
                    html += '</div>';
                    
                    html += '<div class="account-types">';
                    cat.accounts.forEach(acc => {
                        html += '<span class="account-type-badge">' + acc + '</span>';
                    });
                    html += '</div>';
                    
                    // Show subcategories
                    if (cat.subcategories && cat.subcategories.length > 0) {
                        html += '<div class="subcategories">';
                        html += '<strong style="font-size:12px;color:#666;">Subcategories:</strong> ';
                        cat.subcategories.forEach(sub => {
                            html += '<span class="subcategory-item">' + sub + '</span>';
                        });
                        html += '<button class="btn btn-small" style="margin-left:10px;" onclick="app.addSubcategory(' + index + ')">+ Add</button>';
                        html += '</div>';
                    } else {
                        html += '<div class="subcategories">';
                        html += '<button class="btn btn-small" onclick="app.addSubcategory(' + index + ')">+ Add Subcategory</button>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
                
                document.getElementById('categoriesList').innerHTML = html;
            },

            filterCategories: function() {
                const filter = document.getElementById('categoryFilter').value.toLowerCase();
                const items = document.querySelectorAll('.category-item');
                
                items.forEach(item => {
                    const name = item.querySelector('.category-name').textContent.toLowerCase();
                    item.style.display = name.includes(filter) ? '' : 'none';
                });
            },

            addCategory: function() {
                const name = document.getElementById('newCategoryName').value.trim();
                const type = document.getElementById('categoryType').value;
                
                if (!name) {
                    this.msg('‚ö†Ô∏è Please enter a category name', true);
                    return;
                }
                
                const accounts = [];
                if (document.getElementById('catForMizuho').checked) accounts.push('mizuho');
                if (document.getElementById('catForYucho').checked) accounts.push('yucho');
                if (document.getElementById('catForSlsenfin').checked) accounts.push('slsenfin');
                if (document.getElementById('catForRakuten').checked) accounts.push('rakuten');
                if (document.getElementById('catForMedfun').checked) accounts.push('medfun');
                
                if (accounts.length === 0) {
                    this.msg('‚ö†Ô∏è Please select at least one account', true);
                    return;
                }
                
                this.categories.push({
                    name: name,
                    accounts: accounts,
                    type: type,
                    subcategories: []
                });
                
                document.getElementById('newCategoryName').value = '';
                this.renderCategories();
                this.msg('‚úÖ Category added: ' + name);
                this.saveData();
            },

            deleteCategory: function(index) {
                const catName = this.categories[index].name;
                this.categories.splice(index, 1);
                this.renderCategories();
                this.msg('‚úÖ Category deleted: ' + catName);
                this.saveData();
            },

            addSubcategory: function(catIndex) {
                this.showAddSubcategoryModal(catIndex);
            },

            editExpenseField: function(element, category, index, field, currentValue) {
                if (this.editingCell) return;
                
                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');
                
                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                    input.style.width = '120px';
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                    input.style.width = '80px';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue;
                    input.style.width = '150px';
                }
                
                input.style.padding = '2px 4px';
                input.style.fontSize = '11px';
                
                const save = () => {
                    const newValue = input.value;
                    if (newValue) {
                        if (field === 'amount') {
                            this.data[this.month].mizuho.fixedExp[category].actual[index][field] = parseFloat(newValue);
                        } else {
                            this.data[this.month].mizuho.fixedExp[category].actual[index][field] = newValue;
                        }
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };
                
                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };
                
                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            editExtraField: function(element, index, field, currentValue) {
                if (this.editingCell) return;
                
                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');
                
                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                    input.style.width = '120px';
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                    input.style.width = '80px';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue === '-' ? '' : currentValue;
                    input.style.width = '150px';
                }
                
                input.style.padding = '2px 4px';
                input.style.fontSize = '14px';
                
                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month].mizuho.extras[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else if (field !== 'amount') {
                        this.data[this.month].mizuho.extras[index][field] = newValue;
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };
                
                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };
                
                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            deleteFixedExpenseItem: function(category, index) {
                const amount = this.data[this.month].mizuho.fixedExp[category].actual[index].amount;
                this.data[this.month].mizuho.fixedExp[category].actual.splice(index, 1);
                this.render();
                this.msg('‚úÖ Expense deleted (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            deleteExtraExpenseItem: function(index) {
                const amount = this.data[this.month].mizuho.extras[index].amount;
                this.data[this.month].mizuho.extras.splice(index, 1);
                this.render();
                this.msg('‚úÖ Extra expense deleted (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editBudget: function(category, currentBudget) {
                if (this.editingCell) return;
                
                this.showBudgetEditModal(category, currentBudget);
            },
            
            showBudgetEditModal: function(category, currentBudget) {
                let modal = document.getElementById('budgetEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'budgetEditModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeBudgetEditModal()">&times;</span>
                            <div class="modal-header">üí∞ Edit Budget</div>
                            <div class="form-group">
                                <label id="budgetCategoryLabel"></label>
                                <input type="number" id="budgetEditValue" placeholder="Enter amount" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveBudgetEdit()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeBudgetEditModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('budgetCategoryLabel').textContent = 'Budget for ' + category + ':';
                document.getElementById('budgetEditValue').value = currentBudget;
                this.editingBudgetCategory = category;
                modal.style.display = 'block';
                
                setTimeout(() => {
                    const input = document.getElementById('budgetEditValue');
                    input.focus();
                    input.select();
                }, 100);
            },
            
            closeBudgetEditModal: function() {
                const modal = document.getElementById('budgetEditModal');
                if (modal) modal.style.display = 'none';
            },
            
            saveBudgetEdit: function() {
                const value = parseFloat(document.getElementById('budgetEditValue').value);
                if (!isNaN(value) && value >= 0 && this.editingBudgetCategory) {
                    this.data[this.month].mizuho.fixedExp[this.editingBudgetCategory].budget = value;
                    this.render();
                    this.msg('‚úÖ Budget updated for ' + this.editingBudgetCategory + ': ¬•' + this.fmt(value));
                    this.saveData();
                    this.closeBudgetEditModal();
                } else {
                    this.msg('‚ö†Ô∏è Please enter a valid positive number', true);
                }
            },

            deleteFixedCategory: function(category) {
                this.showDeleteCategoryModal(category);
            },
            
            showDeleteCategoryModal: function(category) {
                let modal = document.getElementById('deleteCategoryModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'deleteCategoryModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeDeleteCategoryModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Delete Category</div>
                            <p id="deleteCategoryMsg" style="margin:20px 0;"></p>
                            <button class="btn btn-delete" onclick="app.confirmDeleteCategory(true)">‚úì Yes, Delete</button>
                            <button class="btn" onclick="app.confirmDeleteCategory(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('deleteCategoryMsg').textContent = 
                    'Are you sure you want to delete "' + category + '"? All expense records in this category will be lost.';
                this.deletingCategory = category;
                modal.style.display = 'block';
            },
            
            closeDeleteCategoryModal: function() {
                const modal = document.getElementById('deleteCategoryModal');
                if (modal) modal.style.display = 'none';
                this.deletingCategory = null;
            },
            
            confirmDeleteCategory: function(confirmed) {
                if (confirmed && this.deletingCategory) {
                    const category = this.deletingCategory;
                    delete this.data[this.month].mizuho.fixedExp[category];
                    this.render();
                    this.msg('‚úÖ Fixed expense category deleted: ' + category);
                    this.saveData();
                }
                this.closeDeleteCategoryModal();
            },

            addSubcategory: function(catIndex) {
                this.showAddSubcategoryModal(catIndex);
            },
            
            showAddSubcategoryModal: function(catIndex) {
                let modal = document.getElementById('addSubcategoryModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'addSubcategoryModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeAddSubcategoryModal()">&times;</span>
                            <div class="modal-header">‚ûï Add Subcategory</div>
                            <div class="form-group">
                                <label id="subcategoryCategoryLabel"></label>
                                <input type="text" id="subcategoryNameInput" placeholder="Enter subcategory name" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveSubcategory()" style="margin-top:15px;">‚úÖ Add</button>
                            <button class="btn" onclick="app.closeAddSubcategoryModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('subcategoryCategoryLabel').textContent = 
                    'Add subcategory to: ' + this.categories[catIndex].name;
                document.getElementById('subcategoryNameInput').value = '';
                this.editingCategoryIndex = catIndex;
                modal.style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('subcategoryNameInput').focus();
                }, 100);
            },
            
            closeAddSubcategoryModal: function() {
                const modal = document.getElementById('addSubcategoryModal');
                if (modal) modal.style.display = 'none';
            },
            
            saveSubcategory: function() {
                const subName = document.getElementById('subcategoryNameInput').value.trim();
                if (subName && this.editingCategoryIndex !== undefined) {
                    if (!this.categories[this.editingCategoryIndex].subcategories) {
                        this.categories[this.editingCategoryIndex].subcategories = [];
                    }
                    this.categories[this.editingCategoryIndex].subcategories.push(subName);
                    this.renderCategories();
                    this.msg('‚úÖ Subcategory added: ' + subName);
                    this.saveData();
                    this.closeAddSubcategoryModal();
                }
            },

            addNewFixedCategory: function() {
                const nameEl = document.getElementById('newFixedCatName');
                const budgetEl = document.getElementById('newFixedCatBudget');
                
                if (!nameEl || !budgetEl) return;
                
                const name = nameEl.value.trim();
                const budget = parseFloat(budgetEl.value);
                
                if (!name) {
                    this.msg('‚ö†Ô∏è Please enter a category name', true);
                    return;
                }
                
                if (!budget || isNaN(budget) || budget < 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid budget amount', true);
                    return;
                }
                
                // Check if category already exists
                if (this.data[this.month].mizuho.fixedExp[name]) {
                    this.msg('‚ö†Ô∏è Category already exists', true);
                    return;
                }
                
                // Add to fixed expenses
                this.data[this.month].mizuho.fixedExp[name] = {
                    budget: budget,
                    actual: []
                };
                
                // Add to categories if not exists
                const catExists = this.categories.find(c => c.name === name);
                if (!catExists) {
                    this.categories.push({
                        name: name,
                        accounts: ['mizuho'],
                        type: 'expense',
                        subcategories: []
                    });
                }
                
                this.render();
                this.msg('‚úÖ New fixed expense category added: ' + name + ' (Budget: ¬•' + this.fmt(budget) + ')');
                this.saveData();
            },

            editFundBalance: function(fundIndex, currentBalance) {
                if (this.editingCell) return;
                
                this.showFundBalanceEditModal(fundIndex, currentBalance);
            },
            
            showFundBalanceEditModal: function(fundIndex, currentBalance) {
                let modal = document.getElementById('fundBalanceEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'fundBalanceEditModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeFundBalanceEditModal()">&times;</span>
                            <div class="modal-header">üí∞ Edit Fund Balance</div>
                            <div class="form-group">
                                <label id="fundBalanceLabel"></label>
                                <input type="number" id="fundBalanceEditValue" placeholder="Enter amount" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveFundBalanceEdit()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeFundBalanceEditModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                const fundName = this.data[this.month].yucho.funds[fundIndex].name;
                document.getElementById('fundBalanceLabel').textContent = 'Initial balance for ' + fundName + ':';
                document.getElementById('fundBalanceEditValue').value = currentBalance;
                this.editingFundIndex = fundIndex;
                modal.style.display = 'block';
                
                setTimeout(() => {
                    const input = document.getElementById('fundBalanceEditValue');
                    input.focus();
                    input.select();
                }, 100);
            },
            
            closeFundBalanceEditModal: function() {
                const modal = document.getElementById('fundBalanceEditModal');
                if (modal) modal.style.display = 'none';
            },
            
            saveFundBalanceEdit: function() {
                const value = parseFloat(document.getElementById('fundBalanceEditValue').value);
                if (!isNaN(value) && value >= 0 && this.editingFundIndex !== undefined) {
                    const fundName = this.data[this.month].yucho.funds[this.editingFundIndex].name;
                    this.data[this.month].yucho.funds[this.editingFundIndex].balance = value;
                    this.render();
                    this.msg('‚úÖ Fund balance updated for ' + fundName + ': ¬•' + this.fmt(value));
                    this.saveData();
                    this.closeFundBalanceEditModal();
                } else {
                    this.msg('‚ö†Ô∏è Please enter a valid positive number', true);
                }
            },

            addYuchoExpense: function() {
                const dateEl = document.getElementById('yuchoExpDate');
                const fundEl = document.getElementById('yuchoExpFund');
                const amountEl = document.getElementById('yuchoExpAmt');
                const descEl = document.getElementById('yuchoExpDesc');
                
                if (!dateEl || !fundEl || !amountEl || !descEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }
                
                const date = dateEl.value;
                const fundIdx = parseInt(fundEl.value);
                const amount = parseFloat(amountEl.value);
                const desc = descEl.value.trim();
                
                if (!date) {
                    this.msg('‚ö†Ô∏è Please select a date', true);
                    return;
                }
                
                if (!amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid amount', true);
                    return;
                }
                
                if (!this.data[this.month].yucho.expenses) {
                    this.data[this.month].yucho.expenses = [];
                }
                
                this.data[this.month].yucho.expenses.push({
                    id: Date.now(),
                    date: date,
                    fundIdx: fundIdx,
                    fundName: this.data[this.month].yucho.funds[fundIdx].name,
                    amount: amount,
                    desc: desc || '-'
                });
                
                this.render();
                this.msg('‚úÖ Yucho expense added (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editYuchoExpenseField: function(element, index, field, currentValue) {
                if (this.editingCell) return;
                
                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');
                
                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                    input.style.width = '120px';
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                    input.style.width = '80px';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue === '-' ? '' : currentValue;
                    input.style.width = '150px';
                }
                
                input.style.padding = '2px 4px';
                input.style.fontSize = '11px';
                
                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month].yucho.expenses[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else if (field !== 'amount') {
                        this.data[this.month].yucho.expenses[index][field] = newValue || '-';
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };
                
                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };
                
                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            deleteYuchoExpenseItem: function(index) {
                const amount = this.data[this.month].yucho.expenses[index].amount;
                this.data[this.month].yucho.expenses.splice(index, 1);
                this.render();
                this.msg('‚úÖ Yucho expense deleted (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editFundName: function(fundIndex, currentName) {
                if (this.editingCell) return;
                
                this.showEditFundNameModal(fundIndex, currentName);
            },
            
            showEditFundNameModal: function(fundIndex, currentName) {
                let modal = document.getElementById('editFundNameModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'editFundNameModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeEditFundNameModal()">&times;</span>
                            <div class="modal-header">‚úèÔ∏è Edit Fund Name</div>
                            <div class="form-group">
                                <label>Fund Name:</label>
                                <input type="text" id="editFundNameInput" placeholder="Enter fund name" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveEditFundName()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeEditFundNameModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('editFundNameInput').value = currentName;
                this.editingFundIndex = fundIndex;
                this.editingFundOriginalName = currentName;
                modal.style.display = 'block';
                
                setTimeout(() => {
                    const input = document.getElementById('editFundNameInput');
                    input.focus();
                    input.select();
                }, 100);
            },
            
            closeEditFundNameModal: function() {
                const modal = document.getElementById('editFundNameModal');
                if (modal) modal.style.display = 'none';
            },
            
            saveEditFundName: function() {
                const newName = document.getElementById('editFundNameInput').value.trim();
                
                if (!newName) {
                    this.msg('‚ö†Ô∏è Please enter a fund name', true);
                    return;
                }
                
                if (newName === this.editingFundOriginalName) {
                    this.closeEditFundNameModal();
                    return;
                }
                
                // Check if name already exists
                const exists = this.data[this.month].yucho.funds.find((f, idx) => 
                    f.name === newName && idx !== this.editingFundIndex
                );
                if (exists) {
                    this.msg('‚ö†Ô∏è A fund with this name already exists', true);
                    return;
                }
                
                this.data[this.month].yucho.funds[this.editingFundIndex].name = newName;
                
                // Update fund name in all expenses
                if (this.data[this.month].yucho.expenses) {
                    this.data[this.month].yucho.expenses.forEach(e => {
                        if (e.fundIdx === this.editingFundIndex) {
                            e.fundName = newName;
                        }
                    });
                }
                
                this.render();
                this.msg('‚úÖ Fund name updated to: ' + newName);
                this.saveData();
                this.closeEditFundNameModal();
            },

            addNewFund: function() {
                const nameEl = document.getElementById('newFundName');
                const balanceEl = document.getElementById('newFundBalance');
                
                if (!nameEl || !balanceEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }
                
                const name = nameEl.value.trim();
                const balance = parseFloat(balanceEl.value);
                
                if (!name) {
                    this.msg('‚ö†Ô∏è Please enter a fund name', true);
                    return;
                }
                
                if (isNaN(balance) || balance < 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid initial balance (0 or more)', true);
                    return;
                }
                
                // Check if fund name already exists
                const exists = this.data[this.month].yucho.funds.find(f => f.name === name);
                if (exists) {
                    this.msg('‚ö†Ô∏è A fund with this name already exists', true);
                    return;
                }
                
                this.data[this.month].yucho.funds.push({
                    name: name,
                    balance: balance || 0
                });
                
                this.render();
                this.msg('‚úÖ New fund added: ' + name + ' (¬•' + this.fmt(balance || 0) + ')');
                this.saveData();
            },

            deleteFund: function(fundIndex) {
                const fundName = this.data[this.month].yucho.funds[fundIndex].name;
                
                // Check if fund has any transactions
                let hasTransactions = false;
                
                if (this.data[this.month].yucho.expenses) {
                    hasTransactions = this.data[this.month].yucho.expenses.some(e => e.fundIdx === fundIndex);
                }
                
                if (this.data[this.month].yucho.additions) {
                    hasTransactions = hasTransactions || this.data[this.month].yucho.additions.some(a => a.fundIdx === fundIndex);
                }
                
                if (this.data[this.month].yucho.transfers) {
                    hasTransactions = hasTransactions || this.data[this.month].yucho.transfers.some(t => t.fundIdx === fundIndex);
                }
                
                this.showDeleteFundModal(fundIndex, fundName, hasTransactions);
            },
            
            showDeleteFundModal: function(fundIndex, fundName, hasTransactions) {
                let modal = document.getElementById('deleteFundModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'deleteFundModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:500px;">
                            <span class="close" onclick="app.closeDeleteFundModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Delete Fund</div>
                            <p id="deleteFundMsg" style="margin:20px 0;"></p>
                            <button class="btn btn-delete" onclick="app.confirmDeleteFund(true)">‚úì Yes, Delete</button>
                            <button class="btn" onclick="app.confirmDeleteFund(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                let message = 'Are you sure you want to delete the fund "' + fundName + '"?';
                if (hasTransactions) {
                    message += '\n\n‚ö†Ô∏è WARNING: This fund has transaction history. Deleting it will remove all associated transactions.';
                }
                
                document.getElementById('deleteFundMsg').textContent = message;
                document.getElementById('deleteFundMsg').style.whiteSpace = 'pre-line';
                this.deletingFundIndex = fundIndex;
                modal.style.display = 'block';
            },
            
            closeDeleteFundModal: function() {
                const modal = document.getElementById('deleteFundModal');
                if (modal) modal.style.display = 'none';
                this.deletingFundIndex = null;
            },
            
            confirmDeleteFund: function(confirmed) {
                if (confirmed && this.deletingFundIndex !== null && this.deletingFundIndex !== undefined) {
                    const fundIndex = this.deletingFundIndex;
                    const fundName = this.data[this.month].yucho.funds[fundIndex].name;
                    
                    // Remove the fund
                    this.data[this.month].yucho.funds.splice(fundIndex, 1);
                    
                    // Remove associated transactions
                    if (this.data[this.month].yucho.expenses) {
                        this.data[this.month].yucho.expenses = this.data[this.month].yucho.expenses.filter(e => e.fundIdx !== fundIndex);
                        // Adjust indices for remaining expenses
                        this.data[this.month].yucho.expenses.forEach(e => {
                            if (e.fundIdx > fundIndex) e.fundIdx--;
                        });
                    }
                    
                    if (this.data[this.month].yucho.additions) {
                        this.data[this.month].yucho.additions = this.data[this.month].yucho.additions.filter(a => a.fundIdx !== fundIndex);
                        this.data[this.month].yucho.additions.forEach(a => {
                            if (a.fundIdx > fundIndex) a.fundIdx--;
                        });
                    }
                    
                    if (this.data[this.month].yucho.transfers) {
                        this.data[this.month].yucho.transfers = this.data[this.month].yucho.transfers.filter(t => t.fundIdx !== fundIndex);
                        this.data[this.month].yucho.transfers.forEach(t => {
                            if (t.fundIdx > fundIndex) t.fundIdx--;
                        });
                    }
                    
                    this.render();
                    this.msg('‚úÖ Fund deleted: ' + fundName);
                    this.saveData();
                }
                this.closeDeleteFundModal();
            },

            // Standard Account Functions (SLSenfin, Rakuten, Med & Fun)
            editStandardAccountBalance: function(account, currentBalance) {
                if (this.editingCell) return;
                this.showStandardBalanceEditModal(account, currentBalance);
            },

            showStandardBalanceEditModal: function(account, currentBalance) {
                let modal = document.getElementById('standardBalanceEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'standardBalanceEditModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeStandardBalanceEditModal()">&times;</span>
                            <div class="modal-header">üí∞ Edit Initial Balance</div>
                            <div class="form-group">
                                <label id="standardBalanceLabel"></label>
                                <input type="number" id="standardBalanceEditValue" placeholder="Enter amount" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveStandardBalanceEdit()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeStandardBalanceEditModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                const accName = account === 'slsenfin' ? 'SLSenfin' : account === 'rakuten' ? 'Rakuten' : '7-11 Account (Med & Fun)';
                document.getElementById('standardBalanceLabel').textContent = 'Initial balance for ' + accName + ':';
                document.getElementById('standardBalanceEditValue').value = currentBalance;
                this.editingStandardAccount = account;
                modal.style.display = 'block';

                setTimeout(() => {
                    const input = document.getElementById('standardBalanceEditValue');
                    input.focus();
                    input.select();
                }, 100);
            },

            closeStandardBalanceEditModal: function() {
                const modal = document.getElementById('standardBalanceEditModal');
                if (modal) modal.style.display = 'none';
            },

            saveStandardBalanceEdit: function() {
                const value = parseFloat(document.getElementById('standardBalanceEditValue').value);
                if (!isNaN(value) && this.editingStandardAccount) {
                    this.data[this.month][this.editingStandardAccount].balance = value;
                    this.render();
                    this.msg('‚úÖ Initial balance updated: ¬•' + this.fmt(value));
                    this.saveData();
                    this.closeStandardBalanceEditModal();
                } else {
                    this.msg('‚ö†Ô∏è Please enter a valid number', true);
                }
            },

            addStandardIncome: function(account) {
                const dateEl = document.getElementById('newStdIncDate');
                const sourceEl = document.getElementById('newStdIncSource');
                const amountEl = document.getElementById('newStdIncAmt');
                const descEl = document.getElementById('newStdIncDesc');

                if (!dateEl || !sourceEl || !amountEl || !descEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }

                const date = dateEl.value;
                const source = sourceEl.value.trim();
                const amount = parseFloat(amountEl.value);
                const desc = descEl.value.trim();

                if (!date || !source || !amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please fill all required fields with valid data', true);
                    return;
                }

                if (!this.data[this.month][account].income) {
                    this.data[this.month][account].income = [];
                }

                this.data[this.month][account].income.push({
                    id: Date.now(),
                    date: date,
                    source: source,
                    amount: amount,
                    desc: desc
                });

                this.render();
                this.msg('‚úÖ Income added (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            addStandardExpense: function(account) {
                const dateEl = document.getElementById('newStdExpDate');
                const amountEl = document.getElementById('newStdExpAmt');
                const descEl = document.getElementById('newStdExpDesc');

                if (!dateEl || !amountEl || !descEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }

                const date = dateEl.value;
                const amount = parseFloat(amountEl.value);
                const desc = descEl.value.trim();

                // For Rakuten, also get category
                let category = '';
                if (account === 'rakuten') {
                    const categoryEl = document.getElementById('newStdExpCategory');
                    if (!categoryEl) {
                        this.msg('‚ö†Ô∏è Category field not found', true);
                        return;
                    }
                    category = categoryEl.value.trim();
                    if (!category) {
                        this.msg('‚ö†Ô∏è Please enter a category', true);
                        return;
                    }
                }

                if (!date || !amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please fill all required fields with valid data', true);
                    return;
                }

                if (!this.data[this.month][account].expenses) {
                    this.data[this.month][account].expenses = [];
                }

                const expenseData = {
                    id: Date.now(),
                    date: date,
                    amount: amount,
                    desc: desc
                };

                // Add category only for Rakuten
                if (account === 'rakuten') {
                    expenseData.category = category;
                }

                this.data[this.month][account].expenses.push(expenseData);

                this.render();
                this.msg('‚úÖ Expense added (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editStandardIncomeField: function(element, account, index, field, currentValue) {
                if (this.editingCell) return;

                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');

                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue === '-' ? '' : currentValue;
                }

                input.style.padding = '4px';
                input.style.fontSize = '14px';
                input.style.width = '100%';

                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month][account].income[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Income updated');
                    } else if (field !== 'amount' && newValue) {
                        this.data[this.month][account].income[index][field] = newValue;
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Income updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };

                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };

                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            editStandardExpenseField: function(element, account, index, field, currentValue) {
                if (this.editingCell) return;

                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');

                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue === '-' ? '' : currentValue;
                }

                input.style.padding = '4px';
                input.style.fontSize = '14px';
                input.style.width = '100%';

                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month][account].expenses[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else if (field !== 'amount' && newValue) {
                        this.data[this.month][account].expenses[index][field] = newValue;
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Expense updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };

                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };

                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            deleteStandardIncomeItem: function(account, index) {
                const amount = this.data[this.month][account].income[index].amount;
                this.data[this.month][account].income.splice(index, 1);
                this.render();
                this.msg('‚úÖ Income deleted (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            deleteStandardExpenseItem: function(account, index) {
                const amount = this.data[this.month][account].expenses[index].amount;
                this.data[this.month][account].expenses.splice(index, 1);
                this.render();
                this.msg('‚úÖ Expense deleted (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            // Mizuho Income Functions
            editMizuhoSalary: function(currentSalary) {
                if (this.editingCell) return;
                this.showMizuhoSalaryEditModal(currentSalary);
            },

            showMizuhoSalaryEditModal: function(currentSalary) {
                let modal = document.getElementById('mizuhoSalaryEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'mizuhoSalaryEditModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeMizuhoSalaryEditModal()">&times;</span>
                            <div class="modal-header">üí∞ Edit Monthly Salary</div>
                            <div class="form-group">
                                <label>Monthly Salary:</label>
                                <input type="number" id="mizuhoSalaryEditValue" placeholder="Enter amount" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveMizuhoSalaryEdit()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeMizuhoSalaryEditModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('mizuhoSalaryEditValue').value = currentSalary;
                modal.style.display = 'block';

                setTimeout(() => {
                    const input = document.getElementById('mizuhoSalaryEditValue');
                    input.focus();
                    input.select();
                }, 100);
            },

            closeMizuhoSalaryEditModal: function() {
                const modal = document.getElementById('mizuhoSalaryEditModal');
                if (modal) modal.style.display = 'none';
            },

            saveMizuhoSalaryEdit: function() {
                const value = parseFloat(document.getElementById('mizuhoSalaryEditValue').value);
                if (!isNaN(value) && value >= 0) {
                    this.data[this.month].mizuho.salary = value;
                    this.render();
                    this.msg('‚úÖ Monthly salary updated: ¬•' + this.fmt(value));
                    this.saveData();
                    this.closeMizuhoSalaryEditModal();
                } else {
                    this.msg('‚ö†Ô∏è Please enter a valid number', true);
                }
            },

            editMizuhoPrevBal: function(currentBal) {
                if (this.editingCell) return;
                this.showMizuhoPrevBalEditModal(currentBal);
            },

            showMizuhoPrevBalEditModal: function(currentBal) {
                let modal = document.getElementById('mizuhoPrevBalEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'mizuhoPrevBalEditModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:400px;">
                            <span class="close" onclick="app.closeMizuhoPrevBalEditModal()">&times;</span>
                            <div class="modal-header">üí∞ Edit Previous Balance</div>
                            <div class="form-group">
                                <label>Previous Balance:</label>
                                <input type="number" id="mizuhoPrevBalEditValue" placeholder="Enter amount" style="width:100%;padding:10px;font-size:16px;">
                            </div>
                            <button class="btn btn-success" onclick="app.saveMizuhoPrevBalEdit()" style="margin-top:15px;">‚úÖ Save</button>
                            <button class="btn" onclick="app.closeMizuhoPrevBalEditModal()">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('mizuhoPrevBalEditValue').value = currentBal;
                modal.style.display = 'block';

                setTimeout(() => {
                    const input = document.getElementById('mizuhoPrevBalEditValue');
                    input.focus();
                    input.select();
                }, 100);
            },

            closeMizuhoPrevBalEditModal: function() {
                const modal = document.getElementById('mizuhoPrevBalEditModal');
                if (modal) modal.style.display = 'none';
            },

            saveMizuhoPrevBalEdit: function() {
                const value = parseFloat(document.getElementById('mizuhoPrevBalEditValue').value);
                if (!isNaN(value) && value >= 0) {
                    this.data[this.month].mizuho.prevBal = value;
                    this.render();
                    this.msg('‚úÖ Previous balance updated: ¬•' + this.fmt(value));
                    this.saveData();
                    this.closeMizuhoPrevBalEditModal();
                } else {
                    this.msg('‚ö†Ô∏è Please enter a valid number', true);
                }
            },

            addMizuhoIncome: function() {
                const typeEl = document.getElementById('newMizuhoIncomeType');
                const amountEl = document.getElementById('newMizuhoIncomeAmt');

                if (!typeEl || !amountEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }

                const type = typeEl.value.trim();
                const amount = parseFloat(amountEl.value);

                if (!type) {
                    this.msg('‚ö†Ô∏è Please enter an income type', true);
                    return;
                }

                if (!amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid amount', true);
                    return;
                }

                if (!this.data[this.month].mizuho.additionalIncome) {
                    this.data[this.month].mizuho.additionalIncome = [];
                }

                this.data[this.month].mizuho.additionalIncome.push({
                    id: Date.now(),
                    type: type,
                    amount: amount
                });

                this.render();
                this.msg('‚úÖ Income added: ' + type + ' (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editMizuhoIncomeField: function(element, index, field, currentValue) {
                if (this.editingCell) return;

                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');

                let input;
                if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                    input.style.width = '100px';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue;
                    input.style.width = '200px';
                }

                input.style.padding = '4px';
                input.style.fontSize = '14px';

                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month].mizuho.additionalIncome[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Income updated');
                    } else if (field !== 'amount' && newValue) {
                        this.data[this.month].mizuho.additionalIncome[index][field] = newValue;
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Income updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };

                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };

                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            deleteMizuhoIncomeItem: function(index) {
                const income = this.data[this.month].mizuho.additionalIncome[index];
                this.data[this.month].mizuho.additionalIncome.splice(index, 1);
                this.render();
                this.msg('‚úÖ Income deleted: ' + income.type + ' (¬•' + this.fmt(income.amount) + ')');
                this.saveData();
            },

            // Yucho Direct Deposit Functions
            addYuchoDeposit: function() {
                const dateEl = document.getElementById('yuchoDepDate');
                const fundEl = document.getElementById('yuchoDepFund');
                const amountEl = document.getElementById('yuchoDepAmt');
                const sourceEl = document.getElementById('yuchoDepSource');
                
                if (!dateEl || !fundEl || !amountEl || !sourceEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }
                
                const date = dateEl.value;
                const fundIdx = parseInt(fundEl.value);
                const amount = parseFloat(amountEl.value);
                const source = sourceEl.value.trim();
                
                if (!date) {
                    this.msg('‚ö†Ô∏è Please select a date', true);
                    return;
                }
                
                if (!amount || isNaN(amount) || amount <= 0) {
                    this.msg('‚ö†Ô∏è Please enter a valid amount', true);
                    return;
                }
                
                if (!source) {
                    this.msg('‚ö†Ô∏è Please enter a source', true);
                    return;
                }
                
                if (!this.data[this.month].yucho.additions) {
                    this.data[this.month].yucho.additions = [];
                }
                
                this.data[this.month].yucho.additions.push({
                    id: Date.now(),
                    date: date,
                    fundIdx: fundIdx,
                    fundName: this.data[this.month].yucho.funds[fundIdx].name,
                    amount: amount,
                    source: source
                });
                
                this.render();
                this.msg('‚úÖ Deposit added to ' + this.data[this.month].yucho.funds[fundIdx].name + ' (¬•' + this.fmt(amount) + ')');
                this.saveData();
            },

            editYuchoDepositField: function(element, index, field, currentValue) {
                if (this.editingCell) return;
                
                this.editingCell = element;
                const originalText = element.textContent;
                element.classList.add('editing');
                
                let input;
                if (field === 'date') {
                    input = document.createElement('input');
                    input.type = 'date';
                    input.value = currentValue;
                    input.style.width = '120px';
                } else if (field === 'amount') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = currentValue;
                    input.style.width = '80px';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue === '-' ? '' : currentValue;
                    input.style.width = '150px';
                }
                
                input.style.padding = '2px 4px';
                input.style.fontSize = '11px';
                
                const save = () => {
                    const newValue = input.value;
                    if (field === 'amount' && newValue) {
                        this.data[this.month].yucho.additions[index][field] = parseFloat(newValue);
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Deposit updated');
                    } else if (field !== 'amount') {
                        this.data[this.month].yucho.additions[index][field] = newValue || '-';
                        this.saveData();
                        this.render();
                        this.msg('‚úÖ Deposit updated');
                    } else {
                        element.textContent = originalText;
                        element.classList.remove('editing');
                    }
                    this.editingCell = null;
                };
                
                input.onblur = save;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') save();
                };
                
                element.textContent = '';
                element.appendChild(input);
                input.focus();
                if (input.select) input.select();
            },

            deleteYuchoDepositItem: function(index) {
                const deposit = this.data[this.month].yucho.additions[index];
                this.data[this.month].yucho.additions.splice(index, 1);
                this.render();
                this.msg('‚úÖ Deposit deleted: ' + deposit.fundName + ' (¬•' + this.fmt(deposit.amount) + ')');
                this.saveData();
            },

            // Account Management Functions
            openAccountsModal: function() {
                this.renderCustomAccounts();
                document.getElementById('accountsModal').style.display = 'block';
            },

            closeAccountsModal: function() {
                document.getElementById('accountsModal').style.display = 'none';
            },

            renderCustomAccounts: function() {
                const container = document.getElementById('customAccountsList');
                
                if (!this.customAccounts || this.customAccounts.length === 0) {
                    container.innerHTML = '<h4 style="color:#667eea;margin-bottom:10px;">Custom Accounts:</h4><p style="color:#999;font-size:14px;">No custom accounts yet. Add one above!</p>';
                    return;
                }
                
                let html = '<h4 style="color:#667eea;margin-bottom:10px;">Custom Accounts:</h4>';
                
                this.customAccounts.forEach((acc, index) => {
                    html += '<div class="category-item">';
                    html += '<div class="category-header">';
                    html += '<div class="category-name">üè¶ ' + acc.name + '</div>';
                    html += '<button class="btn btn-delete btn-small" onclick="app.deleteCustomAccount(' + index + ')">üóëÔ∏è Delete</button>';
                    html += '</div>';
                    html += '<div style="font-size:12px;color:#666;margin-top:5px;">ID: ' + acc.id + ' ‚Ä¢ Standard account with income/expense tracking</div>';
                    html += '</div>';
                });
                
                container.innerHTML = html;
            },

            addCustomAccount: function() {
                const nameEl = document.getElementById('newAccountName');
                const idEl = document.getElementById('newAccountId');
                
                if (!nameEl || !idEl) {
                    this.msg('‚ö†Ô∏è Form elements not found', true);
                    return;
                }
                
                const name = nameEl.value.trim();
                const id = idEl.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (!name) {
                    this.msg('‚ö†Ô∏è Please enter an account name', true);
                    return;
                }
                
                if (!id) {
                    this.msg('‚ö†Ô∏è Please enter an account ID (lowercase letters only)', true);
                    return;
                }
                
                // Check if ID already exists in default accounts
                const defaultIds = ['mizuho', 'yucho', 'slsenfin', 'rakuten', 'medfun', 'overview'];
                if (defaultIds.includes(id)) {
                    this.msg('‚ö†Ô∏è This account ID is reserved. Please choose a different one', true);
                    return;
                }
                
                // Check if ID already exists in custom accounts
                if (this.customAccounts.find(a => a.id === id)) {
                    this.msg('‚ö†Ô∏è An account with this ID already exists', true);
                    return;
                }
                
                // Add to custom accounts
                this.customAccounts.push({
                    id: id,
                    name: name
                });
                
                // Initialize this account in all existing months
                for (let monthKey in this.data) {
                    if (!this.data[monthKey][id]) {
                        this.data[monthKey][id] = {
                            balance: 0,
                            income: [],
                            expenses: [],
                            transfers: []
                        };
                    }
                }
                
                // Clear form
                nameEl.value = '';
                idEl.value = '';
                
                this.renderCustomAccounts();
                this.updateAccountSelector();
                this.msg('‚úÖ Custom account added: ' + name);
                this.saveData();
            },

            deleteCustomAccount: function(index) {
                const account = this.customAccounts[index];
                
                // Check if account has any transactions in any month
                let hasTransactions = false;
                for (let monthKey in this.data) {
                    if (this.data[monthKey][account.id]) {
                        const acc = this.data[monthKey][account.id];
                        if ((acc.income && acc.income.length > 0) || 
                            (acc.expenses && acc.expenses.length > 0) || 
                            (acc.transfers && acc.transfers.length > 0) ||
                            (acc.balance && acc.balance !== 0)) {
                            hasTransactions = true;
                            break;
                        }
                    }
                }
                
                this.showDeleteAccountModal(index, account, hasTransactions);
            },

            showDeleteAccountModal: function(index, account, hasTransactions) {
                let modal = document.getElementById('deleteAccountModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'deleteAccountModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:500px;">
                            <span class="close" onclick="app.closeDeleteAccountModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Delete Custom Account</div>
                            <p id="deleteAccountMsg" style="margin:20px 0;white-space:pre-line;"></p>
                            <button class="btn btn-delete" onclick="app.confirmDeleteAccount(true)">‚úì Yes, Delete</button>
                            <button class="btn" onclick="app.confirmDeleteAccount(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                let message = 'Are you sure you want to delete the account "' + account.name + '"?';
                if (hasTransactions) {
                    message += '\n\n‚ö†Ô∏è WARNING: This account has transaction history. Deleting it will remove all associated data from all months.';
                }
                
                document.getElementById('deleteAccountMsg').textContent = message;
                this.deletingAccountIndex = index;
                this.deletingAccount = account;
                modal.style.display = 'block';
            },

            closeDeleteAccountModal: function() {
                const modal = document.getElementById('deleteAccountModal');
                if (modal) modal.style.display = 'none';
                this.deletingAccountIndex = null;
                this.deletingAccount = null;
            },

            confirmDeleteAccount: function(confirmed) {
                if (confirmed && this.deletingAccountIndex !== null && this.deletingAccount) {
                    const account = this.deletingAccount;
                    
                    // Remove from custom accounts
                    this.customAccounts.splice(this.deletingAccountIndex, 1);
                    
                    // Remove from all months
                    for (let monthKey in this.data) {
                        delete this.data[monthKey][account.id];
                    }
                    
                    // If currently viewing this account, switch to overview
                    if (this.acc === account.id) {
                        this.acc = 'overview';
                    }
                    
                    this.renderCustomAccounts();
                    this.updateAccountSelector();
                    this.render();
                    this.msg('‚úÖ Custom account deleted: ' + account.name);
                    this.saveData();
                }
                this.closeDeleteAccountModal();
            },

            // Savings Calculation Functions
            calculateMonthlySavings: function() {
                const d = this.data[this.month];
                if (!d || !d.mizuho) return 0;
                
                // Total income from Mizuho
                const income = d.mizuho.salary || 0;
                
                // Total expenses from Mizuho
                let totalExpenses = 0;
                if (d.mizuho.fixedExp) {
                    for (let cat in d.mizuho.fixedExp) {
                        if (d.mizuho.fixedExp[cat].actual) {
                            d.mizuho.fixedExp[cat].actual.forEach(e => totalExpenses += e.amount);
                        }
                    }
                }
                if (d.mizuho.extras) {
                    d.mizuho.extras.forEach(e => totalExpenses += e.amount);
                }
                
                // Add expenses from savings funds (Yucho funds + other accounts)
                let expensesFromSavings = 0;
                
                // Yucho fund expenses
                if (d.yucho && d.yucho.expenses) {
                    d.yucho.expenses.forEach(e => expensesFromSavings += e.amount);
                }
                
                // Other account expenses
                ['slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                    if (d[acc] && d[acc].expenses) {
                        d[acc].expenses.forEach(e => expensesFromSavings += e.amount);
                    }
                });
                
                // Custom account expenses
                if (this.customAccounts) {
                    this.customAccounts.forEach(customAcc => {
                        if (d[customAcc.id] && d[customAcc.id].expenses) {
                            d[customAcc.id].expenses.forEach(e => expensesFromSavings += e.amount);
                        }
                    });
                }
                
                // Net savings = Income - Mizuho Expenses - Expenses from Savings
                return income - totalExpenses - expensesFromSavings;
            },

            calculateAnnualSavings: function() {
                const currentYear = this.month.split('-')[0];
                let totalSavings = 0;
                
                for (let monthKey in this.data) {
                    if (monthKey.startsWith(currentYear)) {
                        const monthData = this.data[monthKey];
                        if (!monthData || !monthData.mizuho) continue;
                        
                        const income = monthData.mizuho.salary || 0;
                        
                        let expenses = 0;
                        if (monthData.mizuho.fixedExp) {
                            for (let cat in monthData.mizuho.fixedExp) {
                                if (monthData.mizuho.fixedExp[cat].actual) {
                                    monthData.mizuho.fixedExp[cat].actual.forEach(e => expenses += e.amount);
                                }
                            }
                        }
                        if (monthData.mizuho.extras) {
                            monthData.mizuho.extras.forEach(e => expenses += e.amount);
                        }
                        
                        // Add expenses from savings funds
                        let expensesFromSavings = 0;
                        
                        if (monthData.yucho && monthData.yucho.expenses) {
                            monthData.yucho.expenses.forEach(e => expensesFromSavings += e.amount);
                        }
                        
                        ['slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                            if (monthData[acc] && monthData[acc].expenses) {
                                monthData[acc].expenses.forEach(e => expensesFromSavings += e.amount);
                            }
                        });
                        
                        if (this.customAccounts) {
                            this.customAccounts.forEach(customAcc => {
                                if (monthData[customAcc.id] && monthData[customAcc.id].expenses) {
                                    monthData[customAcc.id].expenses.forEach(e => expensesFromSavings += e.amount);
                                }
                            });
                        }
                        
                        totalSavings += (income - expenses - expensesFromSavings);
                    }
                }
                
                return totalSavings;
            },

            getSavingsByFund: function(monthKey) {
                const d = this.data[monthKey];
                if (!d) return [];
                
                const savingsByFund = [];
                
                // Yucho funds
                if (d.yucho && d.yucho.funds) {
                    d.yucho.funds.forEach((fund, idx) => {
                        let deposits = 0;
                        let expenses = 0;
                        
                        if (d.yucho.additions) {
                            d.yucho.additions.forEach(a => {
                                if (a.fundIdx === idx) deposits += a.amount;
                            });
                        }
                        
                        if (d.yucho.expenses) {
                            d.yucho.expenses.forEach(e => {
                                if (e.fundIdx === idx) expenses += e.amount;
                            });
                        }
                        
                        const netSavings = deposits - expenses;
                        if (netSavings !== 0) {
                            savingsByFund.push({
                                account: 'Yucho',
                                fund: fund.name,
                                deposits: deposits,
                                expenses: expenses,
                                net: netSavings
                            });
                        }
                    });
                }
                
                // Other accounts (transfers from Mizuho)
                const accounts = ['slsenfin', 'rakuten', 'medfun'];
                if (this.customAccounts) {
                    this.customAccounts.forEach(acc => accounts.push(acc.id));
                }
                
                accounts.forEach(accId => {
                    if (!d[accId]) return;
                    
                    let transfersIn = 0;
                    let expenses = 0;
                    
                    if (d[accId].transfers) {
                        d[accId].transfers.forEach(t => {
                            if (t.type === 'in' && t.fromAccount === 'mizuho') {
                                transfersIn += t.amount;
                            }
                        });
                    }
                    
                    if (d[accId].expenses) {
                        d[accId].expenses.forEach(e => expenses += e.amount);
                    }
                    
                    const netSavings = transfersIn - expenses;
                    if (netSavings !== 0) {
                        const accName = accId === 'slsenfin' ? 'SLSenfin' :
                                       accId === 'rakuten' ? 'Rakuten' :
                                       accId === 'medfun' ? '7-11 Account' :
                                       this.customAccounts.find(a => a.id === accId)?.name || accId;
                        
                        savingsByFund.push({
                            account: accName,
                            fund: 'Main',
                            deposits: transfersIn,
                            expenses: expenses,
                            net: netSavings
                        });
                    }
                });
                
                return savingsByFund;
            },

            showMonthlySavings: function() {
                this.acc = 'monthly-savings';
                document.getElementById('accountSelect').value = 'monthly-savings';
                this.render();
            },

            showAnnualSavings: function() {
                this.acc = 'annual-savings';
                document.getElementById('accountSelect').value = 'annual-savings';
                this.render();
            },

            renderMonthlySavings: function() {
                const d = this.data[this.month];
                const totalSavings = this.calculateMonthlySavings();
                const savingsByFund = this.getSavingsByFund(this.month);
                
                let html = '<div class="section"><div class="section-title">üí∞ Monthly Savings Report - ' + this.month + '</div>';
                
                // Summary card
                html += '<div class="assets-banner" style="background: linear-gradient(135deg, #43e97b 0%, #38c968 100%);">';
                html += '<div class="assets-label">Total Monthly Savings</div>';
                html += '<div>¬•' + this.fmt(totalSavings) + '</div>';
                html += '</div>';
                
                // Income vs Expenses breakdown
                const income = d.mizuho ? d.mizuho.salary : 0;
                let mizuhoExpenses = 0;
                if (d.mizuho) {
                    if (d.mizuho.fixedExp) {
                        for (let cat in d.mizuho.fixedExp) {
                            if (d.mizuho.fixedExp[cat].actual) {
                                d.mizuho.fixedExp[cat].actual.forEach(e => mizuhoExpenses += e.amount);
                            }
                        }
                    }
                    if (d.mizuho.extras) {
                        d.mizuho.extras.forEach(e => mizuhoExpenses += e.amount);
                    }
                }
                
                // Calculate expenses from savings
                let expensesFromSavings = 0;
                if (d.yucho && d.yucho.expenses) {
                    d.yucho.expenses.forEach(e => expensesFromSavings += e.amount);
                }
                ['slsenfin', 'rakuten', 'medfun'].forEach(acc => {
                    if (d[acc] && d[acc].expenses) {
                        d[acc].expenses.forEach(e => expensesFromSavings += e.amount);
                    }
                });
                if (this.customAccounts) {
                    this.customAccounts.forEach(customAcc => {
                        if (d[customAcc.id] && d[customAcc.id].expenses) {
                            d[customAcc.id].expenses.forEach(e => expensesFromSavings += e.amount);
                        }
                    });
                }
                
                const totalExpenses = mizuhoExpenses + expensesFromSavings;
                
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0;">';
                html += '<div style="background:#e8f5e9;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#43e97b;margin-bottom:10px;">Income</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(income) + '</div>';
                html += '</div>';
                
                html += '<div style="background:#ffebee;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#f5576c;margin-bottom:10px;">Total Expenses</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(totalExpenses) + '</div>';
                html += '<div style="font-size:12px;color:#999;margin-top:5px;">Mizuho: ¬•' + this.fmt(mizuhoExpenses) + '</div>';
                html += '<div style="font-size:12px;color:#999;">From Savings: ¬•' + this.fmt(expensesFromSavings) + '</div>';
                html += '</div>';
                
                html += '<div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#667eea;margin-bottom:10px;">Savings Rate</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">' + (income > 0 ? Math.round((totalSavings / income) * 100) : 0) + '%</div>';
                html += '</div>';
                html += '</div>';
                
                // Savings Breakdown - How it adds up
                html += '<div class="section"><div class="section-title">üìù How Your Savings Add Up</div>';
                html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">';
                
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:white;border-radius:8px;margin-bottom:10px;border-left:4px solid #43e97b;">';
                html += '<div><strong>Total Income (Mizuho Salary)</strong></div>';
                html += '<div style="font-size:18px;font-weight:bold;color:#43e97b;">¬•' + this.fmt(income) + '</div>';
                html += '</div>';
                
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:white;border-radius:8px;margin-bottom:10px;border-left:4px solid #f5576c;">';
                html += '<div><strong>Mizuho Expenses</strong></div>';
                html += '<div style="font-size:18px;font-weight:bold;color:#f5576c;">- ¬•' + this.fmt(mizuhoExpenses) + '</div>';
                html += '</div>';
                
                if (expensesFromSavings > 0) {
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:white;border-radius:8px;margin-bottom:10px;border-left:4px solid #ff9800;">';
                    html += '<div><strong>Expenses from Savings Funds</strong></div>';
                    html += '<div style="font-size:18px;font-weight:bold;color:#ff9800;">- ¬•' + this.fmt(expensesFromSavings) + '</div>';
                    html += '</div>';
                }
                
                html += '<div style="height:2px;background:#ddd;margin:15px 0;"></div>';
                
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#43e97b;color:white;border-radius:8px;font-size:18px;">';
                html += '<div><strong>üí∞ Total Monthly Savings</strong></div>';
                html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(totalSavings) + '</div>';
                html += '</div>';
                
                html += '</div></div>';
                
                // Where Your Savings Went
                html += '<div class="section"><div class="section-title">üíé Where Your Savings Went (Actual Transfers)</div>';
                
                // Collect all savings allocations with fund details
                let savingsAllocations = [];
                
                // Get all transfers from Mizuho
                if (d.mizuho && d.mizuho.transfers) {
                    d.mizuho.transfers.forEach(t => {
                        if (t.type === 'out') {
                            let toAccountName = t.toAccount === 'slsenfin' ? 'SLSenfin' :
                                        t.toAccount === 'rakuten' ? 'Rakuten' :
                                        t.toAccount === 'medfun' ? '7-11 Account' :
                                        t.toAccount === 'yucho' ? 'Yucho' :
                                        this.customAccounts.find(a => a.id === t.toAccount)?.name || t.toAccount;
                            
                            let toFundName = null;
                            let fundIdx = null;
                            
                            // For Yucho transfers, get fund name
                            if (t.toAccount === 'yucho') {
                                // Check if fundIdx exists
                                if (t.fundIdx !== null && t.fundIdx !== undefined && t.fundIdx !== 'main') {
                                    fundIdx = typeof t.fundIdx === 'string' ? parseInt(t.fundIdx) : t.fundIdx;
                                    
                                    // Look up fund name from Yucho funds
                                    if (d.yucho && d.yucho.funds && d.yucho.funds[fundIdx]) {
                                        toFundName = d.yucho.funds[fundIdx].name;
                                    }
                                }
                                
                                // Also check if toFundName is already stored
                                if (t.toFundName) {
                                    toFundName = t.toFundName;
                                }
                            }
                            
                            // Calculate expenses from this fund/account
                            let expensesFromFund = 0;
                            if (t.toAccount === 'yucho' && fundIdx !== null) {
                                if (d.yucho && d.yucho.expenses) {
                                    d.yucho.expenses.forEach(e => {
                                        if (e.fundIdx === fundIdx) expensesFromFund += e.amount;
                                    });
                                }
                            } else if (t.toAccount !== 'yucho' && d[t.toAccount]) {
                                if (d[t.toAccount].expenses) {
                                    d[t.toAccount].expenses.forEach(e => expensesFromFund += e.amount);
                                }
                            }
                            
                            savingsAllocations.push({
                                type: 'transfer',
                                date: t.date,
                                account: toAccountName,
                                fund: toFundName,
                                fundIdx: fundIdx,
                                amount: t.amount,
                                expenses: expensesFromFund,
                                net: t.amount - expensesFromFund,
                                desc: t.desc || '-'
                            });
                        }
                    });
                }
                
                // Get Yucho direct deposits
                if (d.yucho && d.yucho.additions) {
                    d.yucho.additions.forEach(dep => {
                        const fundName = d.yucho.funds[dep.fundIdx] ? d.yucho.funds[dep.fundIdx].name : 'Unknown Fund';
                        
                        // Calculate expenses from this fund
                        let expensesFromFund = 0;
                        if (d.yucho.expenses) {
                            d.yucho.expenses.forEach(e => {
                                if (e.fundIdx === dep.fundIdx) expensesFromFund += e.amount;
                            });
                        }
                        
                        savingsAllocations.push({
                            type: 'deposit',
                            date: dep.date,
                            account: 'Yucho',
                            fund: fundName,
                            amount: dep.amount,
                            expenses: expensesFromFund,
                            net: dep.amount - expensesFromFund,
                            desc: dep.source || '-'
                        });
                    });
                }
                
                // Sort by date
                savingsAllocations.sort((a, b) => a.date.localeCompare(b.date));
                
                let totalAllocated = 0;
                let totalExpensesFromSavings = 0;
                savingsAllocations.forEach(s => {
                    totalAllocated += s.amount;
                    totalExpensesFromSavings += s.expenses;
                });
                
                // Show breakdown
                html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">';
                
                if (savingsAllocations.length > 0) {
                    html += '<h4 style="color:#667eea;margin-bottom:15px;">üí∏ Detailed Breakdown (Amount Transferred)</h4>';
                    html += '<div style="background:white;border-radius:8px;overflow:hidden;margin-bottom:15px;">';
                    
                    savingsAllocations.forEach((s, idx) => {
                        html += '<div style="padding:15px;' + (idx > 0 ? 'border-top:1px solid #f0f0f0;' : '') + '">';
                        
                        // Header row with account and fund name clearly shown
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
                        html += '<div style="flex:1;">';
                        html += '<div style="font-weight:600;color:#333;font-size:16px;">';
                        html += s.account;
                        // Show fund name if it exists and is not null
                        if (s.fund !== null && s.fund !== undefined && s.fund !== 'Main') {
                            html += ' <span style="color:#667eea;font-weight:700;">‚Üí ' + s.fund + '</span>';
                        } else if (s.account === 'Yucho' && s.fundIdx !== null && s.fundIdx !== undefined) {
                            // Fallback: show fund index if name not found
                            html += ' <span style="color:#999;font-style:italic;"> (Fund #' + (s.fundIdx + 1) + ')</span>';
                        }
                        html += '</div>';
                        html += '<div style="font-size:12px;color:#999;margin-top:3px;">' + s.date + ' ‚Ä¢ ' + s.desc + '</div>';
                        html += '</div>';
                        html += '<div style="text-align:right;">';
                        html += '<div style="font-size:18px;font-weight:bold;color:#43e97b;">¬•' + this.fmt(s.amount) + '</div>';
                        html += '</div>';
                        html += '</div>';
                        
                        // If there are expenses from this fund, show them
                        if (s.expenses > 0) {
                            html += '<div style="background:#fff3cd;padding:10px;border-radius:5px;margin-top:8px;">';
                            html += '<div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">';
                            html += '<div style="color:#856404;">‚ö†Ô∏è Expenses from this fund</div>';
                            html += '<div style="font-weight:600;color:#f5576c;">- ¬•' + this.fmt(s.expenses) + '</div>';
                            html += '</div>';
                            html += '</div>';
                            
                            // Net savings
                            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px dashed #ddd;">';
                            html += '<div style="font-size:13px;font-weight:600;color:#666;">Net Saved in this fund</div>';
                            html += '<div style="font-size:14px;font-weight:bold;color:' + (s.net >= 0 ? '#43e97b' : '#f5576c') + ';">¬•' + this.fmt(s.net) + '</div>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    
                    // Summary
                    html += '<div style="background:white;border-radius:8px;padding:15px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
                    html += '<div style="font-weight:600;">Total Transferred to Savings</div>';
                    html += '<div style="font-size:18px;font-weight:bold;color:#43e97b;">¬•' + this.fmt(totalAllocated) + '</div>';
                    html += '</div>';
                    
                    if (totalExpensesFromSavings > 0) {
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
                        html += '<div style="font-weight:600;">Total Spent from Savings</div>';
                        html += '<div style="font-size:18px;font-weight:bold;color:#f5576c;">- ¬•' + this.fmt(totalExpensesFromSavings) + '</div>';
                        html += '</div>';
                        
                        html += '<div style="height:2px;background:#ddd;margin:10px 0;"></div>';
                        
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                        html += '<div style="font-weight:600;">Net Remaining in Savings</div>';
                        html += '<div style="font-size:20px;font-weight:bold;color:#43e97b;">¬•' + this.fmt(totalAllocated - totalExpensesFromSavings) + '</div>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                } else {
                    html += '<div style="padding:20px;background:white;border-radius:8px;text-align:center;color:#999;">No transfers to savings this month</div>';
                }
                
                // Remaining in Mizuho
                const remainingInMizuho = totalSavings - totalAllocated;
                html += '<div style="margin-top:20px;">';
                html += '<h4 style="color:#667eea;margin-bottom:10px;">üíµ Kept in Mizuho Account</h4>';
                html += '<div style="background:white;border-radius:8px;padding:15px;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<div><strong>Savings kept in Mizuho (not transferred)</strong></div>';
                html += '<div style="font-size:18px;font-weight:bold;color:#667eea;">¬•' + this.fmt(remainingInMizuho) + '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                
                html += '</div></div>';
                
                // Simple bar chart visualization
                html += '<div style="margin:30px 0;">';
                html += '<h3 style="color:#333;margin-bottom:15px;">üí∞ Income vs Expenses</h3>';
                html += '<div style="background:#f5f5f5;padding:20px;border-radius:10px;">';
                
                const maxAmount = Math.max(income, totalExpenses);
                const incomeWidth = maxAmount > 0 ? (income / maxAmount) * 100 : 0;
                const expenseWidth = maxAmount > 0 ? (totalExpenses / maxAmount) * 100 : 0;
                
                html += '<div style="margin-bottom:15px;">';
                html += '<div style="font-size:14px;color:#666;margin-bottom:5px;">Income: ¬•' + this.fmt(income) + '</div>';
                html += '<div style="background:#43e97b;height:30px;border-radius:5px;width:' + incomeWidth + '%;"></div>';
                html += '</div>';
                
                html += '<div>';
                html += '<div style="font-size:14px;color:#666;margin-bottom:5px;">Expenses: ¬•' + this.fmt(totalExpenses) + '</div>';
                html += '<div style="background:#f5576c;height:30px;border-radius:5px;width:' + expenseWidth + '%;"></div>';
                html += '</div>';
                
                html += '</div></div>';
                
                // Savings by Fund/Account (with expenses deducted)
                if (savingsByFund.length > 0) {
                    html += '<div class="section"><div class="section-title">üìä Net Savings by Fund/Account (After Expenses)</div>';
                    html += '<div class="table-container"><table><thead><tr><th>Account</th><th>Fund</th><th>Deposits/Transfers</th><th>Expenses</th><th>Net Savings</th></tr></thead><tbody>';
                    
                    savingsByFund.forEach(item => {
                        html += '<tr>';
                        html += '<td>' + item.account + '</td>';
                        html += '<td>' + item.fund + '</td>';
                        html += '<td style="color:#43e97b;">¬•' + this.fmt(item.deposits) + '</td>';
                        html += '<td style="color:#f5576c;">¬•' + this.fmt(item.expenses) + '</td>';
                        html += '<td style="font-weight:bold;color:' + (item.net >= 0 ? '#43e97b' : '#f5576c') + ';">¬•' + this.fmt(item.net) + '</td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div></div>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
            },

            renderAnnualSavings: function() {
                const currentYear = this.month.split('-')[0];
                const totalAnnual = this.calculateAnnualSavings();
                
                let html = '<div class="section"><div class="section-title">üìà Annual Savings Report - ' + currentYear + '</div>';
                
                // Summary card
                html += '<div class="assets-banner" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);">';
                html += '<div class="assets-label">Total Annual Savings</div>';
                html += '<div>¬•' + this.fmt(totalAnnual) + '</div>';
                html += '</div>';
                
                // Monthly breakdown
                const monthlyData = [];
                let totalIncome = 0;
                let totalExpenses = 0;
                
                for (let monthKey in this.data) {
                    if (monthKey.startsWith(currentYear)) {
                        const d = this.data[monthKey];
                        if (!d || !d.mizuho) continue;
                        
                        const income = d.mizuho.salary || 0;
                        let expenses = 0;
                        
                        if (d.mizuho.fixedExp) {
                            for (let cat in d.mizuho.fixedExp) {
                                if (d.mizuho.fixedExp[cat].actual) {
                                    d.mizuho.fixedExp[cat].actual.forEach(e => expenses += e.amount);
                                }
                            }
                        }
                        if (d.mizuho.extras) {
                            d.mizuho.extras.forEach(e => expenses += e.amount);
                        }
                        
                        const savings = income - expenses;
                        totalIncome += income;
                        totalExpenses += expenses;
                        
                        monthlyData.push({
                            month: monthKey,
                            income: income,
                            expenses: expenses,
                            savings: savings
                        });
                    }
                }
                
                monthlyData.sort((a, b) => a.month.localeCompare(b.month));
                
                // Annual summary
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0;">';
                html += '<div style="background:#e8f5e9;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#43e97b;margin-bottom:10px;">Total Income</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(totalIncome) + '</div>';
                html += '</div>';
                
                html += '<div style="background:#ffebee;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#f5576c;margin-bottom:10px;">Total Expenses</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">¬•' + this.fmt(totalExpenses) + '</div>';
                html += '</div>';
                
                html += '<div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#667eea;margin-bottom:10px;">Average Savings Rate</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">' + (totalIncome > 0 ? Math.round((totalAnnual / totalIncome) * 100) : 0) + '%</div>';
                html += '</div>';
                
                html += '<div style="background:#fff3e0;padding:20px;border-radius:10px;text-align:center;">';
                html += '<h3 style="color:#ffa500;margin-bottom:10px;">Months Tracked</h3>';
                html += '<div style="font-size:24px;font-weight:bold;">' + monthlyData.length + '</div>';
                html += '</div>';
                html += '</div>';
                
                // Monthly trend chart
                if (monthlyData.length > 0) {
                    html += '<div style="margin:30px 0;">';
                    html += '<h3 style="color:#333;margin-bottom:15px;">Monthly Savings Trend</h3>';
                    html += '<div style="background:#f5f5f5;padding:20px;border-radius:10px;">';
                    
                    const maxSavings = Math.max(...monthlyData.map(m => Math.max(m.income, m.expenses, Math.abs(m.savings))));
                    
                    monthlyData.forEach(m => {
                        const savingsWidth = maxSavings > 0 ? Math.abs((m.savings / maxSavings) * 100) : 0;
                        const isPositive = m.savings >= 0;
                        
                        html += '<div style="margin-bottom:20px;">';
                        html += '<div style="font-size:13px;color:#666;margin-bottom:5px;font-weight:600;">' + m.month + '</div>';
                        html += '<div style="display:flex;align-items:center;gap:10px;">';
                        html += '<div style="background:' + (isPositive ? '#43e97b' : '#f5576c') + ';height:25px;border-radius:5px;width:' + savingsWidth + '%;min-width:2%;"></div>';
                        html += '<span style="font-size:13px;font-weight:600;color:' + (isPositive ? '#43e97b' : '#f5576c') + ';">¬•' + this.fmt(m.savings) + '</span>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    html += '</div></div>';
                    
                    // Monthly breakdown table
                    html += '<div class="section"><div class="section-title">üìä Monthly Breakdown</div>';
                    html += '<div class="table-container"><table><thead><tr><th>Month</th><th>Income</th><th>Expenses</th><th>Savings</th><th>Savings Rate</th></tr></thead><tbody>';
                    
                    monthlyData.forEach(m => {
                        const rate = m.income > 0 ? Math.round((m.savings / m.income) * 100) : 0;
                        html += '<tr>';
                        html += '<td><strong>' + m.month + '</strong></td>';
                        html += '<td style="color:#43e97b;">¬•' + this.fmt(m.income) + '</td>';
                        html += '<td style="color:#f5576c;">¬•' + this.fmt(m.expenses) + '</td>';
                        html += '<td style="font-weight:bold;color:' + (m.savings >= 0 ? '#43e97b' : '#f5576c') + ';">¬•' + this.fmt(m.savings) + '</td>';
                        html += '<td>' + rate + '%</td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div></div>';
                }
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
            },

            showExpenseAnalysis: function() {
                this.acc = 'expense-analysis';
                document.getElementById('accountSelect').value = 'expense-analysis';
                this.render();
            },

            renderExpenseAnalysis: function() {
                const d = this.data[this.month];
                if (!d || !d.mizuho) {
                    document.getElementById('content').innerHTML = '<div class="section"><p>No data available</p></div>';
                    return;
                }

                let html = '<div class="section"><div class="section-title">üìâ Expense Analysis & Insights - ' + this.month + '</div>';

                // Calculate total expenses
                let totalExpenses = 0;
                let categoryExpenses = {};
                
                // Fixed expenses
                if (d.mizuho.fixedExp) {
                    for (let cat in d.mizuho.fixedExp) {
                        let catTotal = 0;
                        if (d.mizuho.fixedExp[cat].actual) {
                            d.mizuho.fixedExp[cat].actual.forEach(e => catTotal += e.amount);
                        }
                        if (catTotal > 0) {
                            categoryExpenses[cat] = {
                                actual: catTotal,
                                budget: d.mizuho.fixedExp[cat].budget,
                                type: 'fixed'
                            };
                            totalExpenses += catTotal;
                        }
                    }
                }
                
                // Variable expenses
                let variableTotal = 0;
                if (d.mizuho.extras) {
                    d.mizuho.extras.forEach(e => variableTotal += e.amount);
                }
                if (variableTotal > 0) {
                    categoryExpenses['Variable/Extra'] = {
                        actual: variableTotal,
                        budget: 0,
                        type: 'variable'
                    };
                    totalExpenses += variableTotal;
                }

                const income = d.mizuho.salary || 0;
                const expenseRatio = income > 0 ? (totalExpenses / income) * 100 : 0;

                // Summary Banner
                html += '<div class="assets-banner" style="background: linear-gradient(135deg, #f5576c 0%, #dc3b50 100%);">';
                html += '<div class="assets-label">TOTAL MONTHLY EXPENSES</div>';
                html += '<div>¬•' + this.fmt(totalExpenses) + ' <span style="font-size:16px;">(' + Math.round(expenseRatio) + '% of income)</span></div>';
                html += '</div>';

                // Quick Stats
                html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0;">';
                
                // Highest expense category
                let maxCat = null;
                let maxAmount = 0;
                for (let cat in categoryExpenses) {
                    if (categoryExpenses[cat].actual > maxAmount) {
                        maxAmount = categoryExpenses[cat].actual;
                        maxCat = cat;
                    }
                }
                
                html += '<div style="background:#ffebee;padding:20px;border-radius:10px;">';
                html += '<h4 style="color:#f5576c;margin-bottom:10px;">üî¥ Highest Expense</h4>';
                html += '<div style="font-size:14px;font-weight:600;color:#333;">' + (maxCat || 'N/A') + '</div>';
                html += '<div style="font-size:20px;font-weight:bold;margin-top:5px;">¬•' + this.fmt(maxAmount) + '</div>';
                html += '</div>';

                // Budget vs Actual
                let overBudgetCount = 0;
                for (let cat in categoryExpenses) {
                    if (categoryExpenses[cat].type === 'fixed' && categoryExpenses[cat].actual > categoryExpenses[cat].budget) {
                        overBudgetCount++;
                    }
                }
                
                html += '<div style="background:#fff3cd;padding:20px;border-radius:10px;">';
                html += '<h4 style="color:#856404;margin-bottom:10px;">‚ö†Ô∏è Over Budget</h4>';
                html += '<div style="font-size:14px;color:#666;">Categories exceeding budget</div>';
                html += '<div style="font-size:20px;font-weight:bold;margin-top:5px;">' + overBudgetCount + ' categories</div>';
                html += '</div>';

                // Savings rate
                html += '<div style="background:#e3f2fd;padding:20px;border-radius:10px;">';
                html += '<h4 style="color:#667eea;margin-bottom:10px;">üí∞ Expense Ratio</h4>';
                html += '<div style="font-size:14px;color:#666;">Of total income</div>';
                html += '<div style="font-size:20px;font-weight:bold;margin-top:5px;">' + Math.round(expenseRatio) + '%</div>';
                html += '</div>';

                html += '</div>';

                // Category Breakdown with Visual Bars
                html += '<div class="section"><div class="section-title">üìä Expense Breakdown by Category</div>';
                html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;">';

                // Sort by amount
                const sortedCategories = Object.entries(categoryExpenses).sort((a, b) => b[1].actual - a[1].actual);

                sortedCategories.forEach(([cat, data]) => {
                    const percentage = totalExpenses > 0 ? (data.actual / totalExpenses) * 100 : 0;
                    const isOverBudget = data.type === 'fixed' && data.actual > data.budget;
                    
                    html += '<div style="margin-bottom:20px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">';
                    html += '<div style="font-weight:600;color:#333;">' + cat + (isOverBudget ? ' ‚ö†Ô∏è' : '') + '</div>';
                    html += '<div style="font-weight:600;">¬•' + this.fmt(data.actual) + ' <span style="color:#999;font-size:12px;">(' + Math.round(percentage) + '%)</span></div>';
                    html += '</div>';
                    
                    if (data.type === 'fixed') {
                        const budgetUsage = data.budget > 0 ? (data.actual / data.budget) * 100 : 0;
                        html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">';
                        html += '<div style="flex:1;background:#e0e0e0;height:25px;border-radius:5px;overflow:hidden;">';
                        html += '<div style="background:' + (isOverBudget ? '#f5576c' : '#43e97b') + ';height:100%;width:' + Math.min(budgetUsage, 100) + '%;transition:width 0.3s;"></div>';
                        html += '</div>';
                        html += '<div style="min-width:80px;text-align:right;font-size:12px;color:#666;">¬•' + this.fmt(data.budget) + ' budget</div>';
                        html += '</div>';
                    } else {
                        html += '<div style="background:#667eea;height:20px;border-radius:5px;width:' + percentage + '%;"></div>';
                    }
                    html += '</div>';
                });

                html += '</div></div>';

                // AI-Powered Insights & Suggestions
                html += '<div class="section"><div class="section-title">üí° Intelligent Insights & Suggestions</div>';
                html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;">';

                const insights = this.generateExpenseInsights(categoryExpenses, income, totalExpenses);
                
                insights.forEach(insight => {
                    const iconColor = insight.type === 'warning' ? '#ff9800' : 
                                     insight.type === 'alert' ? '#f5576c' : 
                                     insight.type === 'success' ? '#43e97b' : '#667eea';
                    
                    html += '<div style="background:white;padding:15px;margin-bottom:15px;border-radius:8px;border-left:4px solid ' + iconColor + ';">';
                    html += '<div style="display:flex;align-items:start;gap:10px;">';
                    html += '<div style="font-size:24px;">' + insight.icon + '</div>';
                    html += '<div style="flex:1;">';
                    html += '<div style="font-weight:600;color:#333;margin-bottom:5px;">' + insight.title + '</div>';
                    html += '<div style="color:#666;font-size:14px;margin-bottom:8px;">' + insight.description + '</div>';
                    if (insight.action) {
                        html += '<div style="background:#e8eaf6;padding:10px;border-radius:5px;font-size:13px;">';
                        html += '<strong>üí° Suggestion:</strong> ' + insight.action;
                        html += '</div>';
                    }
                    html += '</div></div></div>';
                });

                html += '</div></div>';

                // Historical Comparison (if multiple months exist)
                const months = Object.keys(this.data).sort();
                if (months.length > 1) {
                    html += '<div class="section"><div class="section-title">üìà Historical Trend (Last 3 Months)</div>';
                    html += '<div style="background:#f8f9fa;padding:20px;border-radius:10px;">';
                    
                    const currentIndex = months.indexOf(this.month);
                    const recentMonths = months.slice(Math.max(0, currentIndex - 2), currentIndex + 1);
                    
                    let maxExpense = 0;
                    const monthlyData = recentMonths.map(m => {
                        let total = 0;
                        if (this.data[m].mizuho.fixedExp) {
                            for (let cat in this.data[m].mizuho.fixedExp) {
                                if (this.data[m].mizuho.fixedExp[cat].actual) {
                                    this.data[m].mizuho.fixedExp[cat].actual.forEach(e => total += e.amount);
                                }
                            }
                        }
                        if (this.data[m].mizuho.extras) {
                            this.data[m].mizuho.extras.forEach(e => total += e.amount);
                        }
                        maxExpense = Math.max(maxExpense, total);
                        return { month: m, total };
                    });
                    
                    monthlyData.forEach((data, idx) => {
                        const width = maxExpense > 0 ? (data.total / maxExpense) * 100 : 0;
                        const isCurrentMonth = data.month === this.month;
                        
                        html += '<div style="margin-bottom:15px;">';
                        html += '<div style="font-size:13px;color:#666;margin-bottom:5px;font-weight:' + (isCurrentMonth ? '700' : '500') + ';">' + data.month + (isCurrentMonth ? ' (Current)' : '') + '</div>';
                        html += '<div style="display:flex;align-items:center;gap:10px;">';
                        html += '<div style="flex:1;background:#e0e0e0;height:30px;border-radius:5px;overflow:hidden;">';
                        html += '<div style="background:' + (isCurrentMonth ? '#667eea' : '#43e97b') + ';height:100%;width:' + width + '%;display:flex;align-items:center;padding-left:10px;color:white;font-weight:600;font-size:13px;">¬•' + this.fmt(data.total) + '</div>';
                        html += '</div>';
                        html += '</div></div>';
                    });
                    
                    // Trend analysis
                    if (monthlyData.length >= 2) {
                        const change = monthlyData[monthlyData.length - 1].total - monthlyData[monthlyData.length - 2].total;
                        const changePercent = monthlyData[monthlyData.length - 2].total > 0 ? (change / monthlyData[monthlyData.length - 2].total) * 100 : 0;
                        
                        html += '<div style="margin-top:15px;padding:15px;background:' + (change > 0 ? '#ffebee' : '#e8f5e9') + ';border-radius:8px;">';
                        html += '<strong>' + (change > 0 ? 'üìà Increased' : 'üìâ Decreased') + ' by ¬•' + this.fmt(Math.abs(change)) + '</strong> ';
                        html += '<span style="color:#666;">(' + (change > 0 ? '+' : '') + Math.round(changePercent) + '%) from last month</span>';
                        html += '</div>';
                    }
                    
                    html += '</div></div>';
                }

                html += '</div>';
                document.getElementById('content').innerHTML = html;
            },

            generateExpenseInsights: function(categoryExpenses, income, totalExpenses) {
                const insights = [];
                
                // Check expense ratio
                const expenseRatio = income > 0 ? (totalExpenses / income) * 100 : 0;
                
                if (expenseRatio > 80) {
                    insights.push({
                        type: 'alert',
                        icon: 'üö®',
                        title: 'High Expense Ratio',
                        description: 'You\'re spending ' + Math.round(expenseRatio) + '% of your income, leaving only ' + Math.round(100 - expenseRatio) + '% for savings.',
                        action: 'Try to bring expenses down to 70% of income to build better savings. Focus on the highest expense categories first.'
                    });
                } else if (expenseRatio > 70) {
                    insights.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        title: 'Moderate Expense Ratio',
                        description: 'Spending ' + Math.round(expenseRatio) + '% of income is manageable but leaves limited room for savings.',
                        action: 'Consider reviewing variable expenses and setting stricter budgets for non-essential categories.'
                    });
                } else {
                    insights.push({
                        type: 'success',
                        icon: '‚úÖ',
                        title: 'Healthy Expense Ratio',
                        description: 'Great job! You\'re spending only ' + Math.round(expenseRatio) + '% of your income, leaving ' + Math.round(100 - expenseRatio) + '% for savings and investments.',
                        action: 'Maintain this discipline and consider increasing your savings allocation to Yucho funds.'
                    });
                }
                
                // Check over-budget categories
                const overBudgetCats = [];
                for (let cat in categoryExpenses) {
                    if (categoryExpenses[cat].type === 'fixed' && categoryExpenses[cat].actual > categoryExpenses[cat].budget) {
                        const overspend = categoryExpenses[cat].actual - categoryExpenses[cat].budget;
                        overBudgetCats.push({ name: cat, overspend, percentage: (overspend / categoryExpenses[cat].budget) * 100 });
                    }
                }
                
                if (overBudgetCats.length > 0) {
                    overBudgetCats.sort((a, b) => b.overspend - a.overspend);
                    const top = overBudgetCats[0];
                    insights.push({
                        type: 'warning',
                        icon: 'üí∏',
                        title: 'Budget Overspend Detected',
                        description: top.name + ' exceeded budget by ¬•' + this.fmt(top.overspend) + ' (' + Math.round(top.percentage) + '% over).',
                        action: 'Review your ' + top.name + ' spending pattern. Consider setting daily/weekly limits or finding cost-effective alternatives.'
                    });
                }
                
                // Find highest expense category
                let maxCat = null;
                let maxAmount = 0;
                for (let cat in categoryExpenses) {
                    if (categoryExpenses[cat].actual > maxAmount) {
                        maxAmount = categoryExpenses[cat].actual;
                        maxCat = cat;
                    }
                }
                
                if (maxCat && maxAmount > 0) {
                    const percentage = (maxAmount / totalExpenses) * 100;
                    if (percentage > 30) {
                        insights.push({
                            type: 'info',
                            icon: 'üìä',
                            title: 'Dominant Expense Category',
                            description: maxCat + ' accounts for ' + Math.round(percentage) + '% of your total expenses (¬•' + this.fmt(maxAmount) + ').',
                            action: 'Since this is your largest expense, even small percentage reductions here will significantly impact total savings.'
                        });
                    }
                }
                
                // Smart suggestions based on category patterns
                if (categoryExpenses['Food and Others'] && categoryExpenses['Food and Others'].actual > 40000) {
                    insights.push({
                        type: 'tip',
                        icon: 'üçΩÔ∏è',
                        title: 'Food Expense Optimization',
                        description: 'Food expenses are trending high at ¬•' + this.fmt(categoryExpenses['Food and Others'].actual) + '.',
                        action: 'Try meal planning for the week, cooking in batches, and reducing dining out frequency. Target: ¬•35,000-40,000/month.'
                    });
                }
                
                if (categoryExpenses['Transport'] && categoryExpenses['Transport'].actual > 15000) {
                    insights.push({
                        type: 'tip',
                        icon: 'üöá',
                        title: 'Transportation Cost Check',
                        description: 'Transport costs are at ¬•' + this.fmt(categoryExpenses['Transport'].actual) + '.',
                        action: 'Consider monthly commuter passes if you take the same route daily. They often save 10-20% compared to individual tickets.'
                    });
                }
                
                // Positive reinforcement
                const sortedCats = Object.entries(categoryExpenses).sort((a, b) => a[1].actual - b[1].actual);
                if (sortedCats.length > 0 && sortedCats[0][1].type === 'fixed') {
                    const lowestCat = sortedCats[0];
                    if (lowestCat[1].actual < lowestCat[1].budget) {
                        insights.push({
                            type: 'success',
                            icon: 'üåü',
                            title: 'Great Budget Control!',
                            description: 'You stayed well under budget for ' + lowestCat[0] + ' (¬•' + this.fmt(lowestCat[1].actual) + ' of ¬•' + this.fmt(lowestCat[1].budget) + ').',
                            action: 'Keep up this discipline! Consider applying the same mindset to other categories.'
                        });
                    }
                }
                
                return insights;
            },

            // Edit Transfer Fund Functions
            editTransferFund: function(account, transferIndex) {
                const transfer = this.data[this.month][account].transfers[transferIndex];
                if (!transfer || transfer.toAccount !== 'yucho') {
                    this.msg('‚ö†Ô∏è Can only edit fund for Yucho transfers', true);
                    return;
                }
                
                this.editingTransfer = { account: account, index: transferIndex };
                
                // Populate fund dropdown
                const select = document.getElementById('editTransferFundSelect');
                select.innerHTML = '<option value="">-- Select Fund --</option>';
                
                if (this.data[this.month].yucho && this.data[this.month].yucho.funds) {
                    this.data[this.month].yucho.funds.forEach((fund, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = fund.name;
                        if (transfer.fundIdx === idx) option.selected = true;
                        select.appendChild(option);
                    });
                }
                
                document.getElementById('editTransferFundModal').style.display = 'block';
            },

            closeEditTransferFundModal: function() {
                document.getElementById('editTransferFundModal').style.display = 'none';
                this.editingTransfer = null;
            },

            saveTransferFundEdit: function() {
                if (!this.editingTransfer) return;
                
                const fundIdx = document.getElementById('editTransferFundSelect').value;
                if (!fundIdx) {
                    this.msg('‚ö†Ô∏è Please select a fund', true);
                    return;
                }
                
                const { account, index } = this.editingTransfer;
                const transfer = this.data[this.month][account].transfers[index];
                
                // Update the transfer with fund info
                transfer.fundIdx = parseInt(fundIdx);
                transfer.toFundName = this.data[this.month].yucho.funds[parseInt(fundIdx)].name;
                
                // Find and update the linked transfer in Yucho account
                if (transfer.linkedId && this.data[this.month].yucho.transfers) {
                    const linkedTransfer = this.data[this.month].yucho.transfers.find(t => t.id === transfer.linkedId);
                    if (linkedTransfer) {
                        linkedTransfer.fundIdx = parseInt(fundIdx);
                        linkedTransfer.fromFundName = transfer.toFundName;
                    }
                }
                
                this.closeEditTransferFundModal();
                this.render();
                this.msg('‚úÖ Transfer fund updated to: ' + transfer.toFundName);
                this.saveData();
            },

            // Delete Transfer Functions
            deleteTransfer: function(account, transferIndex) {
                const transfer = this.data[this.month][account].transfers[transferIndex];
                if (!transfer) return;
                
                this.showDeleteTransferModal(account, transferIndex, transfer);
            },

            showDeleteTransferModal: function(account, transferIndex, transfer) {
                let modal = document.getElementById('deleteTransferModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'deleteTransferModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:500px;">
                            <span class="close" onclick="app.closeDeleteTransferModal()">&times;</span>
                            <div class="modal-header">‚ö†Ô∏è Delete Transfer</div>
                            <p id="deleteTransferMsg" style="margin:20px 0;"></p>
                            <button class="btn btn-delete" onclick="app.confirmDeleteTransfer(true)">‚úì Yes, Delete</button>
                            <button class="btn" onclick="app.confirmDeleteTransfer(false)">Cancel</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                const typeStr = transfer.type === 'out' ? 'outgoing' : 'incoming';
                const otherAccount = transfer.type === 'out' ? transfer.toAccount : transfer.fromAccount;
                document.getElementById('deleteTransferMsg').textContent = 
                    'Delete this ' + typeStr + ' transfer of ¬•' + this.fmt(transfer.amount) + ' to/from ' + otherAccount + '?\n\nThis will also delete the linked transfer in the other account.';
                
                this.deletingTransfer = { account, index: transferIndex, transfer };
                modal.style.display = 'block';
            },

            closeDeleteTransferModal: function() {
                const modal = document.getElementById('deleteTransferModal');
                if (modal) modal.style.display = 'none';
                this.deletingTransfer = null;
            },

            confirmDeleteTransfer: function(confirmed) {
                if (!confirmed || !this.deletingTransfer) {
                    this.closeDeleteTransferModal();
                    return;
                }
                
                const { account, index, transfer } = this.deletingTransfer;
                
                // Delete the transfer
                this.data[this.month][account].transfers.splice(index, 1);
                
                // Find and delete the linked transfer
                if (transfer.linkedId) {
                    const otherAccount = transfer.type === 'out' ? transfer.toAccount : transfer.fromAccount;
                    if (this.data[this.month][otherAccount] && this.data[this.month][otherAccount].transfers) {
                        const linkedIdx = this.data[this.month][otherAccount].transfers.findIndex(t => t.id === transfer.linkedId);
                        if (linkedIdx !== -1) {
                            this.data[this.month][otherAccount].transfers.splice(linkedIdx, 1);
                        }
                    }
                }
                
                this.closeDeleteTransferModal();
                this.render();
                this.msg('‚úÖ Transfer deleted (¬•' + this.fmt(transfer.amount) + ')');
                this.saveData();
            }
        };

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        app.init();
    </script>
</body>
</html>
